---
description: NUBI Pipeline V3 상세 + 교통비 A/B 로직 + Gemini 프롬프트 규칙
alwaysApply: true
---

# Pipeline V3 상세 규칙

## Step 1: Gemini 완전 일정 생성
- **모델**: Gemini 3.0 Flash (`gemini-3-flash-preview`)
- **입력**: 사용자 9개 입력을 자연어 상세 평문화하여 프롬프트 구성
- **9개 입력**: 목적지, 시작일/종료일, 동행유형(인원수), 바이브(최대3개), 여행스타일(예산), 이동방식, 여행속도, 큐레이션, 생년월일
- **출력**: 일차별 완전한 일정 JSON (장소명, 시간, 타입, 설명 포함)
- **병렬**: DB 사전 로드 + 한국 감성 데이터 동시 수행

## Step 2: 데이터 보강 + 비용 산정
- DB 매칭 (places → 좌표, 사진, 점수)
- nubiReason 생성 (generateNubiReason)
- 교통비 카테고리 A/B 분기
- 환율/날씨/위기 실시간 보강
- **모든 비용은 1인 1일 기준 (OTA 방식)**

## 교통비 카테고리 A/B 분기

### 판별: shouldApplyGuidePrice()
- A (가이드): mobilityStyle=Minimal/DriveMore OR travelStyle=Premium/Luxury
- B (대중교통): 그 외 전부

### 카테고리 A (가이드 사용자)
- 구간 이동: "전용차량이동" (상세 경로 안 보여줌)
- 메인 가격: 가이드 1인/일 (가용시간 기준, 8시간 기본)
- 비교 가격: 우버블랙 시간제 1인/일 (같은 가용시간, 대기 포함)
- 지방이동: 50% 할증 자동 적용
- 대중교통: 숨김

### 카테고리 B (대중교통 사용자)
- 구간 이동: 도보/메트로/버스 상세 (노선, 시간, 거리, 실제 요금)
- 메인 가격: 대중교통 1인/일
- 업셀: "(가이드 이용시 1인 €120)" 클릭 가능

## nubiReason 우선순위 (generateNubiReason)
1. 한국인 인기도 (koreanPopularityScore > 50)
2. 패키지투어 포함 여부
3. 포토스팟 점수
4. TripAdvisor 순위/평점
5. 구글 리뷰 수 (userRatingCount)
6. Nubi 종합 점수 (finalScore)
- **절대 null 불가** — 반드시 1개 이상의 이유 생성

## 가이드 가격 (guide_prices DB)
- 세단(1-4명): 기본 4시간 €240 + 추가 €60/h
- 밴(5-7명): 기본 4시간 €320 + 추가 €80/h
- 미니버스(8+명): 기본 4시간 €400 + 추가 €100/h
- 지방이동: 세단 €720, 밴 €990, 미니버스 €1,200

## 식사비 (travelStyle별, 1인/일)
- Economic: €23 (점심 €8, 저녁 €15)
- Reasonable: €60 (점심 €21, 저녁 €39)
- Premium: €110 (점심 €39, 저녁 €72)
- Luxury: €160 (점심 €56, 저녁 €104)
