# 📋 개발 태스크 (TASK.md)

> **최종 업데이트: 2026-01-15 (수)**

---

# 🔒 데이터 무결성 원칙 (영구 보존)

> **이 섹션은 DB 데이터 품질 보장 원칙입니다. 모든 개발자 준수 필수.**

---

## 📌 한글 인코딩 원칙

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│   🇰🇷 NUBI DB = 한국어 기본 (UTF-8 강제)                                    │
│                                                                              │
│   ✅ 정상 한글: 서울, 파리, 경복궁                                          │
│   ❌ 깨진 한글: ì„œìš¸, íŒŒë¦¬, ê²½ë³µê¶                                     │
│                                                                              │
│   💡 원인: 스크립트 실행 시 인코딩 미설정                                    │
│   💡 해결: db.ts에서 client_encoding=UTF8 강제                              │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 필수 체크리스트

| 항목 | 설명 | 적용 위치 |
|------|------|-----------|
| **DB Pool 설정** | `options: "-c client_encoding=UTF8"` | `server/db.ts` |
| **연결 시 설정** | `SET client_encoding TO 'UTF8'` | Pool.on('connect') |
| **저장 전 검증** | `hasBrokenEncoding()` 함수 사용 | 모든 INSERT/UPDATE |
| **스크립트 실행** | `require('dotenv').config()` 먼저 | 모든 Node.js 스크립트 |

### 유틸리티 함수

```typescript
// server/utils/db-encoding.ts
import { hasBrokenEncoding, sanitizeForDB, validateBeforeSave } from './utils/db-encoding';

// 깨진 인코딩 감지
if (hasBrokenEncoding(data.title)) {
  console.warn('깨진 데이터 감지, 저장 거부');
  return;
}

// 저장 전 정화
const cleanData = sanitizeForDB(rawData);
```

---

## 📊 정기 데이터 품질 점검

| 주기 | 작업 | 스크립트 |
|------|------|----------|
| 매일 새벽 | 깨진 데이터 감지 | `scripts/check-db-status.js` |
| 매주 | 중복 데이터 제거 | `scripts/clean-broken-data.js` |
| 배포 전 | 전체 테이블 검증 | `scripts/db-encoding-fix.js` |

---

# 🏛️ NUBI 핵심 알고리즘 아키텍처 (영구 보존)

> **이 섹션은 앱의 핵심 가치와 알고리즘을 기록합니다. 수정 금지.**
> 
> 작성일: 2026-01-14 | 버전: 1.0

---

## 🎯 앱의 핵심 가치

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│   🎯 NUBI = 사용자 성향 분석 + AI 일정 생성 + 영상 미리보기 (차별화)         │
│                                                                              │
│   ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                  │
│   │  📊 성향분석  │ →  │  🧠 AI 생성  │ →  │  🎬 영상예고  │                  │
│   │  (8가지 입력) │    │  (Gemini)    │    │  (차별화)    │                  │
│   └──────────────┘    └──────────────┘    └──────────────┘                  │
│                                                                              │
│   💰 실제 지불자 = 가입 회원 (95% 이상)                                      │
│   📧 회원정보: 생년월일 → 연령대 파악 → 타겟 마케팅                          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 📱 프론트엔드 8가지 사용자 입력 구조도

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│                    📱 NUBI 사용자 입력 플로우 (8단계)                        │
│                                                                              │
│  ╔═══════════════════════════════════════════════════════════════════════╗  │
│  ║                                                                        ║  │
│  ║   1️⃣ 언제 (dates)                    ▶ 기본 정보                      ║  │
│  ║   ├─ 출발일, 종료일 선택                                               ║  │
│  ║   └─ dayCount 계산                                                     ║  │
│  ║                                                                        ║  │
│  ║   2️⃣ 시간 (startTime, endTime)       ▶ 기본 정보                      ║  │
│  ║   ├─ 출발시간, 종료시간 입력                                           ║  │
│  ║   └─ 슬롯 시작/종료 기준                                               ║  │
│  ║                                                                        ║  │
│  ╠═══════════════════════════════════════════════════════════════════════╣  │
│  ║                                                                        ║  │
│  ║   3️⃣ 누구랑 (companionType)          ▶ 일정 생성 요소                 ║  │
│  ║   ├─ 혼자 (1인) → sedan                                                ║  │
│  ║   ├─ 커플 (2인) → sedan                                                ║  │
│  ║   ├─ 가족 (3-4인) → sedan                                              ║  │
│  ║   ├─ 대가족 (5-7인) → van                                              ║  │
│  ║   └─ 친구들 (8+인) → minibus                                           ║  │
│  ║   ⭐ 비용 계산 + 차량 확정의 로우데이터                                 ║  │
│  ║                                                                        ║  │
│  ║   4️⃣ 누구를 위한 (curationFocus)     ▶ 일정 생성 요소 (가중치 1순위)  ║  │
│  ║   ├─ 아이 중심 (Kids)                                                  ║  │
│  ║   ├─ 부모님 중심 (Parents)                                             ║  │
│  ║   ├─ 모두 (Everyone)                                                   ║  │
│  ║   └─ 나 자신 (Self)                                                    ║  │
│  ║   ⭐ Gemini 일정 선택의 "주인공" + 영상의 주인공                        ║  │
│  ║                                                                        ║  │
│  ║   5️⃣ 무엇을 - 취향 (vibes)           ▶ 일정 생성 요소 + 영상 시나리오 ║  │
│  ║   ├─ 최대 3개 선택, 순서 중요!                                         ║  │
│  ║   ├─ 1순위: 50% | 2순위: 30% | 3순위: 20%                              ║  │
│  ║   ├─ 2개 선택시: 60% | 40%                                             ║  │
│  ║   └─ 로그인 회원정보에 저장 → 마케팅 활용                              ║  │
│  ║   ⭐ 영상의 시나리오가 됨 (무엇을 하는지)                               ║  │
│  ║                                                                        ║  │
│  ║   6️⃣ 일정 밀도 (travelPace)          ▶ 일정 생성 요소 + 예산          ║  │
│  ║   ├─ 빡빡하게 (Packed): 1.5시간/곳, 8곳/일                             ║  │
│  ║   ├─ 보통 (Normal): 2시간/곳, 6곳/일                                   ║  │
│  ║   └─ 여유롭게 (Relaxed): 2.5시간/곳, 4곳/일                            ║  │
│  ║   ⭐ 슬롯 수 결정 → 가용시간 결정 → 교통비 영향                         ║  │
│  ║                                                                        ║  │
│  ╠═══════════════════════════════════════════════════════════════════════╣  │
│  ║                                                                        ║  │
│  ║   7️⃣ 예산 (travelStyle)              ▶ 예산 핵심                      ║  │
│  ║   ├─ 럭셔리 (Luxury): 가이드 포함, 식사 €70/끼                         ║  │
│  ║   ├─ 프리미엄 (Premium): 가이드 포함, 식사 €50/끼                      ║  │
│  ║   ├─ 합리적 (Reasonable): 우버+대중교통, 식사 €30/끼                   ║  │
│  ║   └─ 경제적 (Economic): 대중교통만, 식사 €10/끼                        ║  │
│  ║   ⭐ Luxury/Premium → 가이드 가격 포함                                 ║  │
│  ║   ⭐ Reasonable/Economic → 가이드 가격 별도 표시 (마케팅)              ║  │
│  ║                                                                        ║  │
│  ║   8️⃣ 이동 스타일 (mobilityStyle)     ▶ 예산 (교통비 원칙)             ║  │
│  ║   ├─ 많이 걷기 (WalkMore): 대중교통만 (실시간 실제 요금)               ║  │
│  ║   ├─ 적당히 (Moderate): 대중교통+우버 (실시간 실제 요금)               ║  │
│  ║   └─ 이동 최소화 (Minimal): 드라이빙 가이드 (시간당 요금)              ║  │
│  ║   ⭐ mobilityStyle=Minimal OR travelStyle=Premium/Luxury               ║  │
│  ║     → 동일한 "나의 가격" 1회만 적용 (중복 X)                           ║  │
│  ║                                                                        ║  │
│  ╚═══════════════════════════════════════════════════════════════════════╝  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 🧮 일정 생성 알고리즘 (확정)

### 데이터 흐름

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│                      📊 NUBI 일정 생성 데이터 플로우                         │
│                                                                              │
│  ┌───────────────┐                                                          │
│  │ 사용자 입력    │ (8가지)                                                  │
│  │ (프론트엔드)   │                                                          │
│  └───────┬───────┘                                                          │
│          │                                                                   │
│          ▼                                                                   │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                         📥 로우데이터 수집                             │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │  │
│  │  │ 회원정보     │  │ 도시 DB     │  │ 장소 DB     │  │ 가격 DB     │   │  │
│  │  │ (연령대)     │  │ (cities)    │  │ (places)    │  │ (prices)    │   │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│          │                                                                   │
│          ▼                                                                   │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                         🧠 성향 분석 엔진                              │  │
│  │                                                                        │  │
│  │  입력 분류:                                                            │  │
│  │  • 1-2번: 기본 정보 (날짜, 시간)                                       │  │
│  │  • 3-6번: 일정 생성 핵심 (Gemini 프롬프트 + 영상 소스)                 │  │
│  │  • 6-8번: 예산 산정 (교통비 + 식사비 + 입장료)                         │  │
│  │                                                                        │  │
│  │  가중치 시스템:                                                        │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │ 1. ⭐ 주인공 (curationFocus) ← 최우선 가중치                     │  │  │
│  │  │ 2. 누구랑 (companionType) ← 차량/인원 결정                       │  │  │
│  │  │ 3. 바이브 (vibes) ← 50/30/20% 가중치                             │  │  │
│  │  │ 4. 예산 수준 (travelStyle) ← 비용 등급                           │  │  │
│  │  │ 5. 실제 정보 (영업시간, 리뷰)                                    │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│          │                                                                   │
│          ▼                                                                   │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                         🤖 Gemini AI 일정 생성                         │  │
│  │                                                                        │  │
│  │  프롬프트 구성:                                                        │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │ ## 🎯 [가중치 1순위] 일정 생성의 주인공                          │  │  │
│  │  │ **{protagonistSentence}**                                        │  │  │
│  │  │ 예: "5살 아이를 동반한 한국인 가족의 힐링+미식 파리 여행"        │  │  │
│  │  │                                                                  │  │  │
│  │  │ ## 사용자 여행 조건                                              │  │  │
│  │  │ - 바이브: {vibes} (가중치 적용)                                  │  │  │
│  │  │ - 스타일: {travelStyle}                                          │  │  │
│  │  │ - 밀도: {travelPace} (하루 N곳, M분 간격)                        │  │  │
│  │  │                                                                  │  │  │
│  │  │ ## 한국 감성 데이터                                              │  │  │
│  │  │ - 인스타 인기: {instagramData}                                   │  │  │
│  │  │ - 블로그 리뷰: {naverBlogData}                                   │  │  │
│  │  │ - 유튜브 추천: {youtubeData}                                     │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│          │                                                                   │
│          ▼                                                                   │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                         📅 최종 일정표 생성                            │  │
│  │                                                                        │  │
│  │  ┌──────────────────────────┐  ┌──────────────────────────┐           │  │
│  │  │ 📍 일정 (슬롯별)          │  │ 💰 비용 (일별/인당)       │           │  │
│  │  │ • 장소명                  │  │ • 교통비 (소숫점 정밀)    │           │  │
│  │  │ • 시간                    │  │ • 식사비                  │           │  │
│  │  │ • 이동시간                │  │ • 입장료 (Gemini 실시간)  │           │  │
│  │  │ • 추천이유                │  │ • 합계                    │           │  │
│  │  └──────────────────────────┘  └──────────────────────────┘           │  │
│  │                                                                        │  │
│  │  + 🎬 영상 미리보기 데이터 (차별화)                                    │  │
│  │    • protagonistSentence → 영상 나레이션                               │  │
│  │    • vibes → 영상 분위기/BGM                                           │  │
│  │    • 장소 사진 → 8초 클립                                              │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 💰 비용 산정 알고리즘 (확정)

### 교통비 (MobilityStyle 기반)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│                    🚗 교통비 산정 (소숫점 정밀 계산)                         │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                                                                        │  │
│  │  🗺️ 많이 걷기 (WalkMore)                                              │  │
│  │  └─ 대중교통 실제 요금                                                 │  │
│  │     • t+ 티켓: €2.15/회                                                │  │
│  │     • 카르네(10장): €1.69/회                                           │  │
│  │     • Navigo 일일권: €8.65                                             │  │
│  │     • Navigo 주간권: €30.75                                            │  │
│  │     → 최적의 방법 자동 선택                                            │  │
│  │                                                                        │  │
│  ├───────────────────────────────────────────────────────────────────────┤  │
│  │                                                                        │  │
│  │  🧭 적당히 (Moderate)                                                  │  │
│  │  └─ 대중교통 + UberX 실제 요금                                         │  │
│  │     • 대중교통: 4회/일                                                 │  │
│  │     • UberX: 2회/일                                                    │  │
│  │     • UberX 계산: €2.50 + (5.5km×€1.05) + (18분×€0.35) = €14.58/회    │  │
│  │                                                                        │  │
│  ├───────────────────────────────────────────────────────────────────────┤  │
│  │                                                                        │  │
│  │  🏠 이동 최소화 (Minimal)                                              │  │
│  │  └─ 드라이빙 가이드 시간당 요금                                        │  │
│  │     • 세단 (1-4인): €240 (기본4h) + €60/h                              │  │
│  │     • 밴 (5-7인): €320 (기본4h) + €80/h                                │  │
│  │     • 미니버스 (8+인): €400 (기본4h) + €100/h                          │  │
│  │     • 계산: 6.5h = €240 + (2.5 × €60) = €390.00                        │  │
│  │                                                                        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ⚠️ 마케팅 로직 (중복 방지):                                                │
│  • mobilityStyle = Minimal → 가이드 가격 적용                               │
│  • travelStyle = Premium/Luxury → 가이드 가격 적용                          │
│  • 둘 다 선택 → 동일한 가격 1회만 적용!                                     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 식사비 (TravelStyle 기반)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│                    🍽️ 식사비 산정 (1끼/1인 기준)                            │
│                                                                              │
│  ┌───────────────┬───────────┬─────────────────────────────────────────┐   │
│  │ TravelStyle   │ 가격      │ 설명                                    │   │
│  ├───────────────┼───────────┼─────────────────────────────────────────┤   │
│  │ 🏆 Luxury     │ €70/끼    │ 미슐랭 1~3스타급                        │   │
│  │ 👍 Premium    │ €50/끼    │ 트렌디 레스토랑                         │   │
│  │ 💵 Reasonable │ €30/끼    │ 현지인 맛집                             │   │
│  │ 🪙 Economic   │ €10/끼    │ 스트리트푸드/간편식                     │   │
│  └───────────────┴───────────┴─────────────────────────────────────────┘   │
│                                                                              │
│  계산: €가격 × 2끼/일 × 인원수 × 일수                                       │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 입장료 (Gemini 실시간 검색)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│                    🎫 입장료 산정 (사용자 신뢰의 원천)                       │
│                                                                              │
│  1. Gemini 웹 검색으로 실제 입장료 조회                                     │
│  2. 캐시 저장 (7일 유효)                                                    │
│  3. 검색 실패시 타입별 기본값 적용                                          │
│                                                                              │
│  기본값:                                                                     │
│  • museum: €15 | art_gallery: €12 | tourist_attraction: €10                 │
│  • amusement_park: €45 | zoo: €25 | spa: €35                                │
│  • landmark/church/park: €0 (무료)                                          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 🎬 영상 미리보기 시스템 (차별화 포인트)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│                    🎬 영상 미리보기 (NUBI 차별화)                            │
│                                                                              │
│  입력 데이터:                                                                │
│  • protagonistSentence: "5살 아이를 동반한 가족의 힐링 파리 여행"           │
│  • vibes: [Healing, Foodie, Culture]                                        │
│  • 장소별 사진 데이터                                                        │
│                                                                              │
│  생성 결과:                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  🎥 "나만을 위한 파리 3일" (~1분)                                    │   │
│  │                                                                      │   │
│  │  [8초] 에펠탑 + 나레이션: "아이와 함께하는 특별한 순간"              │   │
│  │  [8초] 루브르 + BGM: 힐링 분위기                                     │   │
│  │  [8초] 르쥴베른 + 자막: "미슐랭 맛집"                                │   │
│  │  ...                                                                 │   │
│  │                                                                      │   │
│  │  제공 대상: 유료 회원 / 가이드 일정 확정 고객                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 🗂️ 관련 파일 구조

```
server/services/
├── itinerary-generator.ts      # 일정 생성 핵심 로직
├── protagonist-generator.ts    # 주인공 문장 생성
├── budget-calculator.ts        # 예산 계산 (소숫점 정밀)
├── transport-pricing-service.ts # 교통비 계산 (MobilityStyle)
├── korean-sentiment-service.ts # 한국 감성 데이터
└── vibe-processor.ts           # 바이브 가중치 처리

client/screens/
├── TripPlannerScreen.tsx       # 8단계 입력 UI
└── PlanModalScreen.tsx         # 모달 형태 입력

shared/
└── schema.ts                   # DB 스키마 (itineraries, users, guidePrices)
```

---

## 📊 회원 데이터 활용

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│                    👤 회원 정보 = 마케팅 핵심 자산                           │
│                                                                              │
│  저장 항목:                                                                  │
│  • 생년월일 → 연령대 파악 (10대/20대/30대/40대/50대+)                       │
│  • preferredVibes → 취향 저장 (마케팅 활용)                                 │
│  • preferredCompanionType → 동행 유형                                        │
│  • preferredTravelStyle → 예산 수준                                          │
│  • marketingConsent → 마케팅 동의 여부                                       │
│                                                                              │
│  활용:                                                                       │
│  • 실제 지불자 확률 95%+ → 타겟 마케팅                                       │
│  • 취향 기반 → 맞춤 푸시 알림                                               │
│  • 연령대 기반 → 적합한 상품 추천                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

> **이 알고리즘 아키텍처는 2026-01-14 확정되었습니다.**
> **수정 시 반드시 버전 업데이트 및 변경 이력을 기록하세요.**

---

## 🎯 최종 목표 (Vision)

> **35년차 파리 한국인 가이드**의 노하우 + 신뢰 + 감동 → **신규 고객 획득 마케팅 도구**

### 핵심 차별화
| 요소 | 설명 |
|------|------|
| 🧠 **신뢰** | 실제 현장 가격 데이터 + 정밀 점수 (소수점) |
| 💎 **감동** | 사용자 취향 맞춤 AI 영상 하이라이트 |
| 📊 **투명성** | 일별 비용 합산 / 인당 표시 |

---

## 🗺️ 큰 그림 (Big Picture)

### 일정 생성 시나리오 (2단계)

#### STEP 1: 감동 영상 프리뷰 (바이럴용)
```
┌─────────────────────────────────────────┐
│  🎬 당신만을 위한 파리 3일 미리보기      │
│                                         │
│  [8초 영상] × 방문지 수 = ~1분 하이라이트 │
│                                         │
│  • 로우데이터 실제 사진 기반             │
│  • 사용자 연령대 + 취향 반영 AI 편집     │
│  • BGM + 자막으로 감동 극대화           │
└─────────────────────────────────────────┘
```

#### STEP 2: 상세 일정표 (신뢰용)
```
┌─────────────────────────────────────────┐
│  📅 Day 1 - 2월 1일 (토)                │
│  출발: 09:00 | 교통: VIP 전용차량        │
│                                         │
│  1. [🖼️] 에펠탑      ★★★★☆ 8.72     │
│           입장료 €26 | 10:00-12:00      │
│                                         │
│  2. [🖼️] 르쥴베른    ★★★★★ 9.15     │
│           점심 €85 | 12:30-14:00        │
│                                         │
│  ─────────────────────────────────      │
│  Day 1 합계: €211 (1인당 €106)          │
│  교통비: €100 | 식비: €85 | 입장: €26   │
└─────────────────────────────────────────┘
```

---

## 💰 travelStyle 시나리오 (호텔 제외)

| travelStyle | priceLevel | 교통 | 식사 | 가이드 | 하루 장소 |
|-------------|-----------|------|------|--------|----------|
| **Luxury** | 4 | VIP 전용차량 | 미슐랭급 | 전담 가이드 동행 | 2곳 (예약/웨이팅최소) |
| **Premium** | 3 | 고급 세단 | 트렌디 레스토랑 | 세단 가이드 | 3곳 |
| **Reasonable** | 2 | 우버+대중교통 | 현지인 맛집 | 워킹 가이드 | 4곳 |
| **Economic** | 1 | 대중교통 | 스트리트푸드 | 없음 (자유) | 5-6곳 |

> 💶 가격 데이터: `server/data/france-transport-prices-2026.json` (35년 현장 경험 기반)

---

## 📈 개발 단계별 로드맵

| Phase | 이름 | 설명 | 상태 |
|-------|------|------|------|
| A | 자산 안정화 | 로우데이터 수집 (YouTube, Naver Blog, Instagram) | ✅ 완료 |
| B | 스코어링 엔진 | 점수 로직 + 예산 계산 + 로딩 UX | 🔄 진행중 |
| B+ | **한국 감성 통합** | Instagram/네이버/YouTube 데이터 Gemini 연동 | 🔄 진행중 |
| C | 관제 현황판 | 관리자 대시보드, 품질 알림, 한국 감성 카드 | ✅ 완료 |
| D | 일정표 UI | 일별 동선 + 썸네일 + 비용 표시 | ⬜ 예정 |
| E | 감동 영상 | 8초×N = 1분 하이라이트 AI 영상 | ⬜ 예정 |

---

## 현재 상태

- **백엔드:** 완료 (데이터 파이프라인, API 엔드포인트, 일정 생성)
- **프론트엔드:** 기본 UI 완료 (4탭 네비게이션, 일정 생성 폼)
- **일정 생성:** ✅ 완료 (다국가/장기 여행 지원, 도시별 그룹핑, **한국 감성 통합**)
- **관리자 대시보드:** ✅ 완료 (실시간 관제탑 + 한국 감성 데이터 카드 + **위기 정보 탭**)
- **한국 감성 데이터:** ✅ **구현 완료** (Gemini Web Search + 7일 캐시 + 프롬프트 통합)
- **여행 밀도 로직:** ✅ **구현 완료** (빡빡하게/적당히/여유롭게 3단계, 동적 시간 슬롯)
- **위기 정보 시스템:** ✅ **구현 완료** (GDELT + Gemini, 파업/시위/교통장애)

---

## 📅 완료 작업 로그

---

### 2026-01-14 (화) - 한국 감성 데이터 + 일정 밀도 로직 설계

#### 🎯 오늘의 주제
1. **백서 가중치 공식 검토 및 확장 설계**
2. **한국 감성 데이터 파이프라인 설계**
3. **관리자 대시보드에 한국 감성 데이터 카드 추가**
4. **여행 밀도별 일정 생성 로직 확정**

---

#### ✅ 완료된 작업 (2026-01-14)

| 작업 | 상태 | 설명 |
|------|------|------|
| 한국 감성 데이터 대시보드 카드 추가 | ✅ | Instagram/네이버/YouTube 우선순위별 표시 |
| 한국 감성 API 엔드포인트 추가 | ✅ | `/api/admin/korean-sentiment/*` 4개 API |
| 대시보드 동기화 버튼 추가 | ✅ | 각 소스별 동기화 버튼 및 기능 |
| 여행 밀도 로직 설계 (확정) | ✅ | 빡빡/보통/여유 3단계 상세 정의 |
| 가중치 공식 확장 설계 | ✅ | Korean_Sentiment_Bonus 추가 설계 |
| **korean-sentiment-service.ts 생성** | ✅ | Gemini Web Search 기반 한국 감성 데이터 서비스 |
| **itinerary-generator.ts 개선** | ✅ | 한국 감성 데이터 + 여행 밀도 로직 통합 |
| **Korean_Sentiment_Bonus 구현** | ✅ | Instagram 40% + 네이버 35% + YouTube 25% 가중치 |
| **동적 시간 슬롯 생성 구현** | ✅ | 출발시간 → 종료시간 자동 계산 로직 |
| **7일 캐시 시스템 구현** | ✅ | geminiWebSearchCache 테이블 활용 |
| **유럽 30개 대표도시 목록 정의** | ✅ | 프랑스/이탈리아/스페인/영국/독일/스위스 등 |
| **대시보드 Gemini 동기화 연결** | ✅ | 3개 버튼 + 전체 동기화 버튼 |
| **캐시 상태 모니터링 UI** | ✅ | 유효/만료/커버리지 표시 |
| **사용자 시간 우선 슬롯 로직 완성** | ✅ | 사용자 출발/종료 시간 절대 우선 + 다일정 최적화 |
| **TravelPace 타입 정렬** | ✅ | 프론트엔드 기준 `Normal` 사용 (Moderate 아님) |
| **다일정 슬롯 계산 로직** | ✅ | 첫날/중간/마지막 날별 가용시간 기반 슬롯 수 자동 계산 |
| **CompanionType 대가족 추가** | ✅ | 혼자/커플/가족/대가족/친구들 5단계 + 인원수 연동 |
| **교통편 자동 확정 로직** | ✅ | 인원별 세단/밴/미니버스 자동 매핑 |
| **transport-pricing-service.ts 생성** | ✅ | 마케팅 가격 스며들기 로직 구현 |
| **mobilityStyle 비용 원칙 정의** | ✅ | WalkMore/Moderate→API, Minimal→가격표 |
| **travelStyle 가이드 포함 정의** | ✅ | Premium/Luxury→가이드가격 포함 (중복X) |
| **시간당 가격 DB 스키마 확장** | ✅ | basePrice4h, pricePerHour, 비교 데이터 필드 추가 |
| **대시보드 시간당 가격 계산기 UI** | ✅ | 세단/밴/미니버스/가이드온리 실시간 계산 |
| **대시보드 우버/택시 비교표 UI** | ✅ | 경쟁사 가격 입력 + 마케팅 메시지 |
| **시간당 가격 API 엔드포인트** | ✅ | GET/POST /api/admin/guide-prices/hourly |
| **가격 계산 API** | ✅ | POST /api/admin/guide-prices/calculate |
| **transport-pricing-service DB 연동** | ✅ | 하드코딩 → DB 실시간 로드로 전환 |
| **DB 마이그레이션 스크립트** | ✅ | scripts/migrate-guide-prices.js 생성 및 실행 |
| **시간당 가격 DB 초기 데이터** | ✅ | sedan/van/minibus/guide_only 4종 데이터 삽입 완료 |
| **DB 연동 테스트 API** | ✅ | GET /api/admin/guide-prices/test |

---

### 🎯 4. 주인공 시스템 (CurationFocus) 구현 (2026-01-14)

**핵심**: "누구를 위한" 여행인지 = Gemini 프롬프트 가중치 1순위

| 작업 | 상태 | 설명 |
|------|------|------|
| **DB 스키마 확장** | ✅ | itineraries 테이블에 curationFocus, protagonistSentence 등 9개 필드 추가 |
| **protagonist-generator.ts 생성** | ✅ | 주인공 문장 생성 서비스 (companionType + curationFocus + vibes 조합) |
| **Gemini 프롬프트 통합** | ✅ | 가중치 1순위로 주인공 컨텍스트 삽입 |
| **DB 마이그레이션** | ✅ | scripts/migrate-itineraries-protagonist.js 실행 완료 |

---

### 🎨 5. 취향선택 (Vibes) 가중치 시스템 (2026-01-14)

**핵심**: 최대 3개, 순서 중요 = 일정 생성 가중치

| 작업 | 상태 | 설명 |
|------|------|------|
| **가중치 로직 확인** | ✅ | 1개:100%, 2개:60/40, 3개:50/30/20 |
| **calculatePlaceVibeScore 개선** | ✅ | 사용자 선택 가중치가 장소 점수에 반영되도록 수정 |
| **users 테이블 취향 저장 필드** | ✅ | preferred_vibes, preferred_companion_type, marketing_consent 추가 |
| **DB 마이그레이션** | ✅ | scripts/migrate-users-vibes.js 실행 완료 |

#### 가중치 적용 공식

```typescript
// 사용자 선택 순서에 따른 가중치
const PRIORITY_WEIGHTS = {
  1: [100],           // 1개 선택: 100%
  2: [60, 40],        // 2개 선택: 60% : 40%  
  3: [50, 30, 20],    // 3개 선택: 50% : 30% : 20%
};

// 장소 점수 = 기본점수 + (매칭된 vibe의 가중치 × 2)
// 예: Romantic(50%) 매칭 → +1.0점 보너스
```

#### 회원 취향 저장 (마케팅 활용)

```
users 테이블:
- preferred_vibes: ["Romantic", "Foodie", "Culture"]  ← 최근 선택한 취향
- preferred_companion_type: "Couple"                   ← 자주 선택하는 동행
- preferred_travel_style: "Premium"                    ← 선호 스타일
- marketing_consent: true                              ← 마케팅 동의
- vibes_updated_at: 2026-01-14T12:00:00Z               ← 마지막 업데이트
```

#### 활용처

1. **일정 생성 가중치**: Gemini 프롬프트에 순서대로 반영
2. **회원 프로필**: 선호 취향 저장 및 추천
3. **마케팅**: 취향 기반 타겟팅
4. **미리보기 영상**: "무엇을 하는지" 시나리오 생성

---

### 🕐 6. 여행 스타일 - 일정 밀도 (TravelPace) 확인 (2026-01-14)

**핵심**: 여정의 슬롯 수 결정 = 이미 확정 및 적용 완료

| 작업 | 상태 | 설명 |
|------|------|------|
| **PACE_CONFIG 정의** | ✅ | Packed(90분/8곳), Normal(120분/6곳), Relaxed(150분/4곳) |
| **calculateSlotsForDay 함수** | ✅ | 사용자 시간 기반 슬롯 수 동적 계산 |
| **프론트엔드 연동** | ✅ | TripPlannerScreen에서 TRAVEL_PACE_OPTIONS 선택 |
| **API 전달** | ✅ | /api/routes/generate에서 formData.travelPace 전달 |
| **일정 생성 적용** | ✅ | itinerary-generator.ts에서 슬롯 분배에 반영 |

#### 슬롯 계산 로직 (확정)

```typescript
const PACE_CONFIG = {
  Packed: {
    slotDurationMinutes: 90,    // 1시간 30분
    maxSlotsPerDay: 8,          // 12h ÷ 1.5h = 8곳
  },
  Normal: {
    slotDurationMinutes: 120,   // 2시간
    maxSlotsPerDay: 6,          // 12h ÷ 2h = 6곳
  },
  Relaxed: {
    slotDurationMinutes: 150,   // 2시간 30분
    maxSlotsPerDay: 4,          // 12h ÷ 2.5h = 4곳
  },
};
```

#### 사용자 시간 우선 규칙

```
1일 여행: 사용자 출발~종료시간 그대로
첫날: 사용자 출발시간 ~ 21:00
중간날: 09:00 ~ 21:00 풀타임
마지막날: 09:00 ~ 사용자 종료시간
```

#### 다음 단계: 최종 표준 일정표 폼

- [ ] 프론트엔드 일정 생성 뼈대 저장
- [ ] 모든 요소 취합한 최종 표준 일정표 폼 설계
- [ ] 일정표 UI 컴포넌트 구현

---

### 💰 7. 예산 시스템 (TravelStyle 기반) 구현 (2026-01-14)

**핵심**: 일일/전체 비용 산정 = 교통비 + 식사비 + 입장료

| 작업 | 상태 | 설명 |
|------|------|------|
| **budget-calculator.ts 리팩토링** | ✅ | TravelStyle 기반 통합 비용 산정 |
| **식사비 로직** | ✅ | Luxury €70, Premium €50, Reasonable €30, Economic €10 |
| **입장료 실시간 검색** | ✅ | Gemini로 실제 입장료 검색 (사용자 신뢰의 원천) |
| **예산 미리보기 API** | ✅ | POST /api/budget/preview |
| **상세 예산 계산 API** | ✅ | POST /api/budget/calculate |
| **스타일별 비교 API** | ✅ | POST /api/budget/compare (4가지 모두 표시) |
| **가이드 가격 표시** | ✅ | 합리적/경제적 선택시에도 프리미엄 가이드 옵션 표시 |

#### 비용 구성 (확정)

```
┌─────────────────────────────────────────────────────────────────┐
│                    💰 TravelStyle별 비용 구성                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ⭐ Luxury (럭셔리)                                              │
│  ├─ 교통: 드라이빙 가이드 (€640/일 밴 기준)                       │
│  ├─ 식사: €70/끼/인 (미슐랭급)                                   │
│  └─ 입장료: Gemini 실시간 검색                                   │
│                                                                  │
│  🏆 Premium (프리미엄)                                           │
│  ├─ 교통: 드라이빙 가이드 (€480/일 세단 기준)                    │
│  ├─ 식사: €50/끼/인 (트렌디 레스토랑)                            │
│  └─ 입장료: Gemini 실시간 검색                                   │
│                                                                  │
│  👍 Reasonable (합리적)                                          │
│  ├─ 교통: 우버+대중교통 (€40/일) + 가이드 가격 표시              │
│  ├─ 식사: €30/끼/인 (현지인 맛집)                                │
│  └─ 입장료: Gemini 실시간 검색                                   │
│                                                                  │
│  💵 Economic (경제적)                                            │
│  ├─ 교통: 대중교통 (€16/일) + 가이드 가격 표시                   │
│  ├─ 식사: €10/끼/인 (스트리트푸드)                               │
│  └─ 입장료: Gemini 실시간 검색                                   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

#### API 엔드포인트

```typescript
// 빠른 미리보기 (버튼 선택시)
POST /api/budget/preview
{ travelStyle, companionCount, dayCount, hoursPerDay }
→ { estimated: { perDay, total, perPerson }, guideOption?: {...} }

// 상세 계산 (일정 생성 후)
POST /api/budget/calculate
{ travelStyle, companionType, companionCount, mobilityStyle, ... }
→ { dailyBreakdowns, totals, guideServiceComparison }

// 4가지 스타일 비교
POST /api/budget/compare
{ companionCount, dayCount }
→ { comparisons: [Luxury, Premium, Reasonable, Economic] }
```

#### 마케팅 전략

```
합리적/경제적 선택시:
→ "💡 프리미엄 가이드 서비스 추가 시 하루 €480 (우버 호출 스트레스 없이 프리미엄 여행!)"
→ guideServiceComparison 객체로 비교 데이터 제공
→ 신규 고객 창출 유도
```

---

### 🚗 8. MobilityStyle 교통비 정밀 계산 구현 (2026-01-14)

**핵심**: 가격 정보 = 가장 민감한 정보 → 소숫점까지 정확하게!

| 작업 | 상태 | 설명 |
|------|------|------|
| **transport-pricing-service.ts 리팩토링** | ✅ | 소숫점 2자리 정밀 계산 |
| **많이 걷기 (WalkMore)** | ✅ | 파리 대중교통 실제 요금 (t+, Navigo) |
| **적당히 (Moderate)** | ✅ | 대중교통 + UberX 실제 요금 |
| **이동 최소화 (Minimal)** | ✅ | 가이드 시간당 요금 (반일 4h 기본) |
| **budget-calculator.ts 연동** | ✅ | round2() 적용 |

#### MobilityStyle별 교통비 산정 (확정)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  MobilityStyle      │  교통비 산정 방식                    │  소숫점 정밀  │
├─────────────────────────────────────────────────────────────────────────────┤
│  🗺️ 많이 걷기       │  파리 대중교통 실제 요금              │     ✅        │
│  (WalkMore)         │  - t+ 티켓: €2.15/회                  │               │
│                     │  - 카르네(10장): €1.69/회             │               │
│                     │  - Navigo 일일권: €8.65               │               │
│                     │  - Navigo 주간권: €30.75              │               │
│                     │  - 하루 4회 이동 기준                  │               │
├─────────────────────────────────────────────────────────────────────────────┤
│  🧭 적당히          │  대중교통 + UberX 실제 요금           │     ✅        │
│  (Moderate)         │  - 대중교통: 4회/일                   │               │
│                     │  - UberX: 2회/일                       │               │
│                     │  - UberX 계산: €2.50 + (5.5km×€1.05)   │               │
│                     │    + (18분×€0.35) = 약 €14.58/회       │               │
├─────────────────────────────────────────────────────────────────────────────┤
│  🏠 이동 최소화     │  드라이빙 가이드 시간당 요금          │     ✅        │
│  (Minimal)          │  - 세단: €240 (기본4h) + €60/h        │               │
│                     │  - 밴: €320 (기본4h) + €80/h          │               │
│                     │  - 미니버스: €400 (기본4h) + €100/h   │               │
│                     │  - 예: 6.5h = €240 + (2.5×€60) = €390 │               │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 소숫점 정밀 계산 예시

```typescript
// 6.5시간 가이드 서비스
basePrice4h = 240
extraHours = 6.5 - 4 = 2.5
dailyPrice = 240 + (2.5 × 60) = €390.00

// 대중교통 + 우버 (커플 2인, 3일)
대중교통: €8.65 × 2인 × 3일 = €51.90
우버: €14.58 × 2회 × 3일 = €87.48
총 교통비: €139.38
```

#### round2() 함수

```typescript
function round2(num: number): number {
  return Math.round(num * 100) / 100;
}
```

---

### 🚨 9. 위기 정보 시스템 구현 (2026-01-14)

**핵심**: GDELT (실시간 뉴스) + Gemini (분석) → 파업/시위/교통장애 알림

| 작업 | 상태 | 설명 |
|------|------|------|
| **crisis-alert-service.ts** | ✅ | GDELT API + Gemini 분석 서비스 |
| **DB 스키마 확장** | ✅ | crisisAlerts 테이블 (다국어, 영향/추천 포함) |
| **스케줄러 연동** | ✅ | 새벽 4:00 KST 자동 수집 (crisis_sync) |
| **대시보드 UI** | ✅ | 🚨 위기 정보 탭 추가 |
| **API 엔드포인트** | ✅ | /api/admin/crisis-alerts/* |

#### 데이터 흐름

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│                    🚨 위기 정보 수집 파이프라인                              │
│                                                                              │
│  ┌───────────────┐    ┌───────────────┐    ┌───────────────┐                │
│  │ GDELT API     │ →  │ Gemini AI     │ →  │ DB 저장       │                │
│  │ (실시간 뉴스) │    │ (분석/구조화) │    │ (crisisAlerts)│                │
│  └───────────────┘    └───────────────┘    └───────────────┘                │
│         │                    │                    │                          │
│         ▼                    ▼                    ▼                          │
│  • Paris strike         • 타입 분류          • 대시보드 표시                 │
│  • RATP grève           • 심각도 평가        • 일정표 팝업 알림              │
│  • metro closure        • 한글 번역          • 푸시 알림                     │
│  • protest              • 여행자 조언        • 가이드 서비스 마케팅          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 수집 대상 (유형별)

| 타입 | 키워드 | 영향 |
|------|--------|------|
| **strike** | 파업, grève, RATP, SNCF | 교통 마비 |
| **protest** | 시위, manifestation | 도로 통제 |
| **traffic** | 교통장애, metro closure | 이동 지연 |
| **weather** | 기상경보, 폭우, 폭설 | 일정 변경 |
| **security** | 테러, 비상상황 | 여행 자제 |

#### API 엔드포인트

```typescript
// 대시보드용 - 전체 알림 + 통계
GET /api/admin/crisis-alerts?city=Paris&type=strike
→ { stats, alerts, lastUpdate }

// 수동 수집
POST /api/admin/crisis-alerts/collect
→ { totalArticles, totalAlerts, savedAlerts, byCity }

// 비활성화
POST /api/admin/crisis-alerts/:id/deactivate

// 일정표용 - 특정 도시 알림
GET /api/crisis-alerts/:city
→ { alerts, hasActiveAlerts, highestSeverity }
```

#### 마케팅 시너지

```
파업 감지 시:
1. 푸시 알림: "⚠️ 여행 기간 중 메트로 파업 예정"
2. 일정표 팝업: 영향 + 가이드 서비스 추천
3. 자연스러운 전환: "파업 영향 없는 VIP 가이드 여행"
→ 신규 고객 전환율 ↑
```

---

#### 주인공 문장 생성 예시

```
curationFocus=Kids, companionType=Family, vibes=[Healing, Foodie]
→ "5살 아이를 동반한 한국인 가족의 힐링+미식 파리 여행 (아이 중심)"

curationFocus=Parents, companionType=Family, companionAges="65,68"
→ "60대 부모님을 모시고 가는 로맨틱 파리 여행 (부모님 체력 고려)"

curationFocus=Everyone, companionType=Couple, vibes=[Romantic, Hotspot]
→ "한국인 커플의 로맨틱+핫스팟 파리 여행"
```

#### Gemini 프롬프트 가중치 순서 (수정됨)

```
1. ⭐ 주인공 (curationFocus 기반) ← NEW: 최우선
2. 누구랑 (companionType)
3. 바이브 선호 (vibes)
4. 예산 수준 (travelStyle)
5. 실제 정보 (영업시간, 리뷰)
```

#### 추후 활용 (미리보기 영상)

- 유료 회원 또는 가이드 일정 확정 고객에게 제공
- 주인공 문장 + 일정 데이터 → AI 영상 생성
- 예: "한국인 커플이 로맨틱 파리를 여행하는 3일" 미리보기

---

#### 💰 설계 문서: 마케팅 비용 구조 (확정 - 2026-01-14)

##### 🎯 핵심: "나의 가격"이 중복 없이 스며드는 로직

```
┌─────────────────────────────────────────────────────────────────┐
│                    💰 마케팅 접점 구조 💰                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  경로 A: mobilityStyle = "이동 최소화" (Minimal)                │
│  ─────────────────────────────────────────                      │
│  → 드라이빙 가이드 (순수 교통비 명목)                           │
│  → 인원별 차량 가격표 적용 (세단/밴/미니버스)                   │
│                                                                 │
│  ────────────── OR ──────────────                               │
│                                                                 │
│  경로 B: travelStyle = "Premium" 또는 "Luxury"                  │
│  ─────────────────────────────────────────                      │
│  → 가이드 + 기타요소 합산 (패키지 명목)                         │
│  → 프리미엄 패키지 가격 적용                                    │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│  ⚠️ 둘 다 선택해도 → 동일 가격 1회만 적용 (중복 X)              │
└─────────────────────────────────────────────────────────────────┘
```

##### 3️⃣ "누구랑" = 인원 + 차량 타입 결정

| CompanionType | 라벨 | 인원 수 | 차량 타입 | 가격표 |
|---------------|------|--------|----------|--------|
| Single | 혼자 | 1명 | 🚗 세단 | €600/일 |
| Couple | 커플 | 2명 | 🚗 세단 | €600/일 |
| Family | 가족 | 3-4명 | 🚗 세단 | €600/일 |
| **ExtendedFamily** | **대가족** | **5-7명** | 🚐 **밴** | €1,015/일 |
| Group | 친구들 | 8명+ | 🚌 미니버스 | €800/일 |

##### 8️⃣ 이동 스타일 (mobilityStyle) = 교통비 원칙

| mobilityStyle | 라벨 | 교통편 | 비용 계산 방식 |
|---------------|------|--------|---------------|
| WalkMore | 많이 걷기 | 대중교통만 | 🗺️ Google Maps API 실시간 |
| Moderate | 적당히 | 대중교통+우버 | 🗺️ Google Maps API 실시간 |
| **Minimal** | **이동 최소화** | **드라이빙 가이드** | 💰 **가격표 적용** |

##### 여행 스타일 (travelStyle) = 패키지 포함 여부

| travelStyle | 라벨 | 가이드 가격 포함 |
|-------------|------|-----------------|
| Luxury | 럭셔리 | ✅ 포함 |
| Premium | 프리미엄 | ✅ 포함 |
| Reasonable | 합리적 | ❌ 미포함 |
| Economic | 경제적 | ❌ 미포함 |

---

#### 📊 설계 문서: 일정 생성 가중치 체계 (확정)

##### 1️⃣ 일정 생성 명령 가중치 순서 (한국인 취향)

| 순위 | 요소 | 설명 | 비고 |
|------|------|------|------|
| **1순위** | 누구랑 (Target) | Single/Couple/Family/ExtendedFamily/Group | 물리적 제약 + 차량 결정 |
| **2순위** | 취향선택 (Vibe) | 힐링/미식/핫스팟/모험/문화/로맨틱 (3개까지) | 순서별 50/30/20% |
| **3순위** | 예산 (Budget) | Luxury/Premium/Reasonable/Economic | 별도 공식 |
| **4순위** | 일정밀도 (Density) | 빡빡/적당/여유 | 장소 수 결정 |
| **5순위** | 기본정보 (Reality) | 날씨, 혼잡도, 운영상태 | 페널티 적용 |

##### 2️⃣ 최종 스코어링 공식 (확장)

```
Final Score = (Base × Target × Vibe) + Korean_Sentiment_Bonus + Style_Adj - Reality_Penalty
```

##### 3️⃣ Korean_Sentiment_Bonus 공식 (NEW)

```
Korean_Sentiment_Bonus = (Instagram_Score × 0.4) 
                       + (NaverBlog_Score × 0.35) 
                       + (YouTube_Score × 0.25)

각 소스별 점수 (0~2점):
- Instagram: postCount > 100K → 2.0 | > 50K → 1.5 | > 10K → 1.0 | > 1K → 0.5
- NaverBlog: very_positive → 2.0 | positive → 1.5 | neutral → 0.5
- YouTube: mentions >= 3 → 2.0 | >= 2 → 1.5 | >= 1 → 1.0
```

---

#### 📐 설계 문서: 여행 밀도별 일정 생성 로직 (확정)

##### 🇰🇷 한국인 여행 스타일 반영 (최종 확정 - 2026-01-14)

| 여행 밀도 | 슬롯 간격 | 풀타임(12h) 기준 장소 | 비고 |
|----------|---------|---------------------|------|
| **빡빡하게 (Packed)** | 1.5시간 | 8곳 | 12h ÷ 1.5h = 8 |
| **보통 (Normal)** | 2시간 | 6곳 | 12h ÷ 2h = 6 |
| **여유롭게 (Relaxed)** | 2.5시간 | 4곳 | 12h ÷ 2.5h ≈ 4 |

##### 🚨 핵심 규칙: 사용자 시간 절대 우선

```
사용자 출발시간 & 종료시간 = 절대 우선
슬롯 수 = 가용시간 ÷ 슬롯간격
```

##### 📅 다일정 계산 로직

| 여행 구분 | Day | 시작시간 | 종료시간 | 슬롯 계산 |
|----------|-----|---------|---------|----------|
| **당일치기** | 1일 | 사용자 입력 | 사용자 입력 | 가용시간 ÷ 슬롯간격 |
| **2일 이상** | 첫날 | 사용자 입력 | 21:00 (기본) | 가용시간 ÷ 슬롯간격 |
| | 중간 | 09:00 (기본) | 21:00 (기본) | 12h ÷ 슬롯간격 = 풀타임 |
| | 마지막 | 09:00 (기본) | 사용자 입력 | 가용시간 ÷ 슬롯간격 |

##### 예시: 3일 여행, 사용자 입력 11:00~16:00, Normal(2시간) 선택

```
Day 1 (첫날):   11:00 ~ 21:00 = 10시간 ÷ 2h = 5곳
Day 2 (중간):   09:00 ~ 21:00 = 12시간 ÷ 2h = 6곳 (풀타임)
Day 3 (마지막): 09:00 ~ 16:00 = 7시간 ÷ 2h = 3곳

총 필요 장소: 5 + 6 + 3 = 14곳
```

##### 종료시간 자동 계산 공식 (코드)

```typescript
const PACE_CONFIG = {
  Packed: { slotDurationMinutes: 90, maxSlotsPerDay: 8 },
  Normal: { slotDurationMinutes: 120, maxSlotsPerDay: 6 },
  Relaxed: { slotDurationMinutes: 150, maxSlotsPerDay: 4 }
};

const DEFAULT_START_TIME = '09:00';
const DEFAULT_END_TIME = '21:00';

// 가용시간으로 슬롯 수 계산
function calculateSlotsForDay(startTime, endTime, pace) {
  const availableMinutes = 종료분 - 시작분;
  return Math.min(
    Math.floor(availableMinutes / pace.slotDurationMinutes),
    pace.maxSlotsPerDay
  );
}
```

---

#### 🔄 로우데이터 파이프라인 시뮬레이션 (설계 완료)

**사용자 입력 예시:**
> "커플이 로맨틱하고 멋진 사진을 찍을 수 있는 파리를 2월 14일부터 여유롭게 합리적인 가격으로 여행"

**파이프라인 흐름:**
```
사용자 입력 파싱
      ↓
TripFormData 구조화
  • companionType: "Couple"
  • vibes: ["Romantic", "Hotspot"]
  • destination: "Paris"
  • travelPace: "Relaxed"
  • travelStyle: "Reasonable"
      ↓
Vibe 가중치 계산 (60%/40%)
      ↓
한국 감성 데이터 수집 (NEW!)
  • 📸 Instagram (40%): 해시태그 게시물 수
  • 📝 네이버 블로그 (35%): 감성 분석
  • 🎬 YouTube (25%): 유튜버 언급 횟수
      ↓
Reality 데이터 수집
  • 날씨, 혼잡도, 운영상태, 교통비
      ↓
Gemini AI 메타프롬프트 생성
  • 사용자 조건 + 한국 감성 데이터 + Reality 포함
      ↓
최종 스코어링 및 일정 생성
```

---

#### 📁 수정된 파일 목록

| 파일 | 변경 내용 |
|------|----------|
| `server/admin-routes.ts` | 한국 감성 API 4개 추가 (`/korean-sentiment/*`) |
| `server/templates/admin-dashboard.html` | 한국 감성 데이터 카드 UI + JS 함수 추가 |
| `server/services/korean-sentiment-service.ts` | 🆕 한국 감성 데이터 서비스 (Gemini Web Search + 캐시) |
| `server/services/itinerary-generator.ts` | 한국 감성 통합 + 여행 밀도 3단계 로직 추가 |
| `server/admin-routes.ts` | 🆕 유럽 30개 도시 목록 + 감성 동기화 API 5개 추가 |
| `server/templates/admin-dashboard.html` | 전체 동기화 버튼 + 캐시 상태 모니터링 UI |

---

#### ⬜ 미완료 작업 (다음 단계)

| 순서 | 작업 | 예상 시간 | 우선순위 |
|------|------|----------|----------|
| ~~1~~ | ~~`itinerary-generator.ts`에 여행 밀도 로직 적용~~ | ~~1시간~~ | ✅ 완료 |
| ~~2~~ | ~~`itinerary-generator.ts`에 한국 감성 데이터 Gemini 프롬프트 통합~~ | ~~2시간~~ | ✅ 완료 |
| ~~3~~ | ~~`Korean_Sentiment_Bonus` 계산 로직 구현~~ | ~~1시간~~ | ✅ 완료 |
| ~~4~~ | ~~관리자 대시보드 Gemini 동기화 연결~~ | ~~30분~~ | ✅ 완료 |
| ~~5~~ | ~~유럽 30개 대표도시 기본 탑재~~ | ~~1시간~~ | ✅ 완료 |
| 6 | 프론트엔드 TravelPace 3단계 UI 추가 (빡빡/적당/여유) | 30분 | 🟡 중간 |
| 7 | 일정 생성 결과에 종료시간 자동 표시 | 30분 | 🟡 중간 |
| 8 | 백서 (NUBI_WHITEPAPER.md) 업데이트 | 30분 | 🟢 낮음 |

---

### 2026-01-11 (토) 12:30 KST

#### ✅ 완료된 작업
| 작업 | 상태 | 설명 |
|------|------|------|
| API 키 인식 문제 해결 | ✅ | 환경변수 재인식 (서버 재시작) |
| api_service_status 업데이트 | ✅ | 모든 서비스 is_configured: true |
| 스케줄 작업 이름 수정 | ✅ | blog_sync→naver_blog_sync, exchange_sync→exchange_rate_sync |
| Firebase 마이그레이션 데이터 export | ✅ | 7개 테이블 JSON 파일 생성 (exports/) |

#### 🔧 시스템 상태 확인
- 스케줄러: 정상 가동 (8개 작업)
- API 서비스: 모두 configured: true
- 데이터 수집: exchange_rate, weather, tripadvisor 정상 동작

---

### 🚀 고도화 작업 계획 (2026-01-11 시작)

#### 핵심 개념
| 개념 | 비유 | 설명 |
|------|------|------|
| 로우데이터 | 🗃️ 자산 | 수집된 원본 데이터 (YouTube, Instagram, 블로그, 가격, 환율) |
| 스코어링 알고리즘 | 🧠 생각하는 뇌 | Vibe/Buzz/Taste 계산 + Reality Penalty |
| 관리자 대시보드 | 📊 관제 현황판 | 데이터 수집 상태, API 모니터링, 품질 관리 |

---

### 📋 백엔드 우선 작업 로드맵

#### Phase A: 자산 안정화 (로우데이터) ✅ 완료
| 순서 | 작업 | 상태 | 예상시간 |
|------|------|------|----------|
| A-1 | sync_logs 테이블 활성화 (수집 이력 추적) | ✅ | 30분 |
| A-2 | YouTube 크롤러 실제 동작 검증 | ✅ | 1시간 |
| A-3 | Instagram 크롤러 검증 | ❌ | - |
| A-4 | Naver Blog 크롤러 검증 | ✅ | 1시간 |
| A-5 | 데이터 품질 검증 API | ✅ | 1시간 |

> ⚠️ **A-3 Instagram 제외 사유**: Meta 로그인 정책 변경으로 헤드리스 크롤링 불가 (2024년 이후 차단)

#### Phase B: 스코어링 엔진 (생각하는 뇌) 🔄 진행중

##### 📐 핵심 공식
```
Personalized Score = Base Score × Vibe Match + Companion Bonus + Style Bonus - Reality Penalty

Base Score = (Vibe + Buzz + Taste) / 3  →  0~10점
Vibe Match = 사용자 Vibe ↔ 장소 Vibe 매칭  →  0.5~1.5 (배수)
Companion Bonus = 동반자 타입 매칭  →  0~2점
Style Bonus = 예산 스타일 매칭  →  0~1점
Reality Penalty = 날씨+혼잡도+운영상태  →  0~5점 (차감)
Final Score = min(10, max(0, Personalized Score))
```

##### 💰 1. 예산 매핑 (travelStyle → priceLevel)
| travelStyle | priceLevel | 설명 | 가격대 예시 |
|-------------|-----------|------|------------|
| Luxury | 4 | 최고급 | 미슐랭, 5성호텔, €100+ |
| Premium | 3 | 고급 | 트렌디 레스토랑, 4성호텔, €50-100 |
| Reasonable | 2 | 합리적 | 현지인 맛집, 3성호텔, €20-50 |
| Economic | 1 | 경제적 | 가성비, 호스텔, €10-20 |

**Style Bonus**: 일치 +1.0, 차이1 +0.5, 차이2+ +0

##### ⚡ 2. 페이스 매핑 (travelPace → placesPerDay) ✅ 2026-01-14 확정

| travelPace | 슬롯 간격 | 오전 장소 | 오후 장소 | 총 장소 | 총 슬롯 |
|------------|---------|----------|----------|--------|--------|
| **Packed (빡빡하게)** | 1.5시간 | 2곳 | 4곳 | 6곳 | 8 |
| **Moderate (적당히)** | 2시간 | 2곳 | 2곳 | 4곳 | 6 |
| **Relaxed (여유롭게)** | 2.5시간 | 1곳 | 2곳 | 3곳 | 5 |

> 📌 **핵심 로직**: 출발시간 + 여행밀도 선택 → 종료시간 자동 계산
> 예) 09:00 출발 + Packed → 21:00 종료 (12시간)

##### 🚶 3. 이동 스타일 (mobilityStyle → 거리/교통)
| mobilityStyle | radiusKm | transport | 특징 |
|---------------|----------|-----------|------|
| WalkMore | 2km | 대중교통만 | 걷기 중심, 지역 밀착 |
| Moderate ★신규 | 3km | 택시/대중교통 | 균형잡힌 이동 |
| Minimal | 5km+ | VIP 전용차량+가이드 | 편안함 우선 |

##### 🎨 4. Vibe 가중치 (baseWeight 기준)
| Vibe | 한글 | baseWeight | 선택시 가중치 계산 |
|------|------|-----------|------------------|
| Healing | 힐링 | 35 | weight / Σ(선택 weights) |
| Foodie | 미식 | 25 | 예: Foodie+Culture 선택 → 25/(25+10)=0.71 |
| Hotspot | 핫스팟 | 15 | |
| Adventure | 모험 | 10 | |
| Culture | 문화/예술 | 10 | |
| Romantic | 로맨틱 | 5 | |

**Vibe Match 배수**: 1.0 + (매칭률 - 0.5) → 0.5~1.5

##### 👥 5. 동반자 보너스 (Companion Bonus)
| companionType | 인원 | 매칭 조건 | 보너스 |
|---------------|------|----------|--------|
| Single | 1명 | 혼밥OK, 1인석, 바(bar) | +1.5 |
| Couple | 2명 | 로맨틱, 야경, 분위기 | +2.0 |
| Family | 3-7명 | goodForChildren, 넓은공간 | +1.5 |
| Group | 7명+ | 단체석, 예약가능, 프라이빗룸 | +1.0 |

##### ⚠️ 6. Reality Penalty
| 요소 | 패널티 | 조건 |
|------|--------|------|
| 날씨 | 0~2점 | 비/눈/폭염 |
| 혼잡도 | 0~1.5점 | 피크타임, 주말 |
| 운영상태 | 0~1.5점 | 휴무, 파업, 공사 |

##### 📱 7. 로딩 화면 시각화 (UX 개선)
```
┌─────────────────────────────────────────┐
│   🧠 맞춤 일정 분석 중...                │
│   ✅ 예산 분석: Premium → priceLevel 3   │
│   ✅ Vibe 가중치: Foodie 0.71            │
│   🔄 동반자 최적화: Couple → 로맨틱 우선  │
│   📊 현재 분석 점수: 8.72                │
└─────────────────────────────────────────┘
```

##### 📋 구현 작업 목록
| 순서 | 작업 | 상태 | 예상시간 |
|------|------|------|----------|
| B-1 | trip.ts에 travelPace 'Normal', mobilityStyle 'Moderate' 추가 + travelStyle 시나리오 정보 | ✅ | 15분 |
| B-2 | scoring-engine.ts - calculatePersonalizedScore 함수 구현 | ✅ | 1시간 |
| B-3 | Vibe Match 점수 계산 로직 (사용자 vibes ↔ 장소 vibeKeywords) | ✅ | - |
| B-4 | Companion Bonus 로직 (장소 속성 매칭) | ✅ | - |
| B-5 | Style Bonus 로직 (priceLevel 매칭) | ✅ | - |
| B-6 | 예산 계산 로직 - france-transport-prices-2026.json 활용 | ⬜ | 1시간 |
| B-7 | TripPlannerScreen UI에 3단계 선택 버튼 추가 (빡빡/적당/여유) | ⬜ | 30분 |
| B-8 | 로딩 화면 개선 - 단계별 분석 시각화 + 소수점 점수 | ⬜ | 1시간 |
| B-9 | 일정 결과 화면 - 일별 동선 + 썸네일 + ★점수 + 비용 합산/인당 | ⬜ | 2시간 |
| B-10 | itinerary-generator.ts Gemini 프롬프트 개선 (JSON 구조 활용) | ⬜ | 1시간 |
| B-11 | 통합 테스트 | ⬜ | 30분 |

##### 📋 한국 감성 통합 작업 목록 (B+ Phase) - 2026-01-14 추가
| 순서 | 작업 | 상태 | 예상시간 |
|------|------|------|----------|
| B+-1 | 관리자 대시보드 한국 감성 데이터 카드 추가 | ✅ | 1시간 |
| B+-2 | 한국 감성 API 엔드포인트 추가 (네이버/YouTube) | ✅ | 30분 |
| B+-3 | `itinerary-generator.ts`에 여행 밀도 로직 적용 | ⬜ | 1시간 |
| B+-4 | `fetchKoreanSentimentData()` 함수 구현 | ⬜ | 1시간 |
| B+-5 | Gemini 프롬프트에 한국 감성 데이터 삽입 | ⬜ | 1시간 |
| B+-6 | `Korean_Sentiment_Bonus` 계산 로직 구현 | ⬜ | 30분 |
| B+-7 | 백서 (NUBI_WHITEPAPER.md) 공식 업데이트 | ⬜ | 30분 |
| B+-8 | 통합 테스트 (시뮬레이션 검증) | ⬜ | 30분 |

#### Phase C: 관제 현황판 강화 ✅ 완료
| 순서 | 작업 | 상태 | 예상시간 |
|------|------|------|----------|
| C-1 | 수집 통계 API (collection-stats) | ✅ | 1시간 |
| C-2 | 데이터 품질 알림 시스템 (data-quality/alerts) | ✅ | 1시간 |
| C-3 | 수집 로그 시각화 API (주간 차트) | ✅ | 1시간 |
| C-4 | 대시보드 UI 개선 (통계 카드 4개 추가) | ✅ | 30분 |

> 📊 **완료된 기능**: YouTube 71영상, 블로그 382건, 장소 언급 42건 실시간 표시 + 품질 알림 + 주간 동기화 차트

#### Phase D: 프론트엔드 UI/UX (최후)
| 순서 | 작업 | 상태 | 예상시간 |
|------|------|------|----------|
| D-1 | VibeBadge 컴포넌트 | ⬜ | 30분 |
| D-2 | 장소 카드 Vibe Score 표시 | ⬜ | 1시간 |
| D-3 | 점수 상세 뷰 | ⬜ | 1시간 |
| D-4 | 관리자 대시보드 UI | ⬜ | 2시간 |

---

### 2026-01-08 (수) 14:00 KST

#### ✅ 완료된 작업
| 작업 | 상태 | 설명 |
|------|------|------|
| "Value First" UX 리디자인 | ✅ | TripPlannerScreen이 첫 화면 (로그인 없이 사용 가능) |
| 인증 플로우 구현 | ✅ | "일정 생성" 클릭 시 인증 체크 → 미인증시 Onboarding 이동 |
| OnboardingScreen 완성 | ✅ | 7개 언어 선택, DD/MM/YYYY 생년월일 입력, 만 18세 검증, 연령대 분류 |
| 소셜 로그인 UI | ✅ | Kakao (노란색) / Google (흰색) 버튼 애플 스타일 디자인 |
| 자동 일정 생성 플로우 | ✅ | Onboarding 완료 후 TripPlannerScreen 복귀 시 자동 생성 시작 |
| FAB 버튼 제거 | ✅ | 중복 네비게이션 제거, 탭 바로 통합 |
| 탭 아이콘 변경 | ✅ | Home 탭 아이콘 compass → edit-3 (일정 작성 의미) |
| 투명 글래스 스타일 푸터 | ✅ | iOS 26 Liquid Glass 디자인 탭 바 적용 |
| HomeScreen 삭제 | ✅ | 불필요한 화면 제거, TripPlannerScreen이 Home 역할 |
| RootStackNavigator 정리 | ✅ | TripPlanner 모달 화면 제거, 네비게이션 단순화 |

#### 🎨 디자인 개선
- 탭 바: 투명 글래스 효과 (BlurView)
- 버튼: 애플 스타일 둥근 모서리 (16-24px radius)
- 카카오 버튼: #FEE500 노란색 배경
- Google 버튼: 흰색 배경 + 검정 테두리
- 생년월일 입력: 카드 스타일 DD/MM/YYYY 분리 입력

---

### 2026-01-06 (월) 02:30 KST

#### ✅ 완료된 작업
| 작업 | 상태 | 설명 |
|------|------|------|
| 경로 최적화 알고리즘 | ✅ | 지리적 그룹핑 + Nearest-neighbor로 도시별 연속 일정 배치 |
| 장기 여행 일정 생성 | ✅ | 10일, 11일, 30일 등 장기 여행 완전 지원 |
| 장소 부족 문제 해결 | ✅ | Gemini 장소 생성 재시도 메커니즘 추가 |
| 날짜 계산 버그 수정 | ✅ | calculateDayCount 함수 디버깅 로그 추가 |
| Day 탭 UI 개선 | ✅ | 각 일차에 도시명 표시 (Day 1 파리) |
| Place/DayPlan 타입 확장 | ✅ | city, region 필드 추가 |

#### 🔍 디버깅 로그 추가
- `[Itinerary] Date inputs` - 받은 날짜 확인
- `[Itinerary] Required places` - 필요 장소 수
- `[Itinerary] Total places` - 생성된 총 장소 수
- `[Itinerary] Schedule entries` - 스케줄 엔트리 수
- `[TripPlanner] API response days count` - 프론트 응답 확인

---

### 🎯 다음 작업 (2026-01-09 예정)

| 우선순위 | 태스크 | 예상 시간 | 설명 |
|----------|--------|----------|------|
| 1 | VibeBadge 컴포넌트 구현 | 30분 | 8+: 보라, 5-7: 주황, <5: 회색 점수 배지 |
| 2 | 장소 카드에 Vibe Score 표시 | 1시간 | 결과 화면 장소별 점수 표시 |
| 3 | 점수 상세 뷰 구현 | 1시간 | Vibe/Buzz/Taste 개별 점수 팝업 |
| 4 | 장소 썸네일 이미지 추가 | 1시간 | 결과 화면 장소별 사진 표시 |
| 5 | 장소별 가격 정보 표시 | 1시간 | 입장료/음식값 등 비용 정보 |

**목표:** 1.2 Vibe Score 표시 완료 (Phase 1 MVP)

---

## Phase 1: MVP 핵심 기능 (현재)

### 1.1 사용자 입력 시스템 🔄 진행중

| 태스크 | 상태 | 설명 |
|--------|------|------|
| 온보딩 플로우 설계 | ✅ | 언어 → 생년월일 → 소셜 로그인 (Value First 방식) |
| 프로필 입력 화면 | ✅ | 생년월일 → 연령대 자동 분류 (20대/30대/40대/50대+) |
| 그룹 선택 화면 | ✅ | TripPlannerScreen에서 동반자 유형 선택 통합 |
| 취향 선택 화면 | ✅ | TripPlannerScreen에서 Vibe/페이스/스타일 선택 통합 |
| 일정 입력 화면 | ✅ | TripPlannerScreen에서 목적지/날짜/시간 입력 완료 |

---

## 📍 1.1.1 목적지 입력 시스템 상세 계획

### 🎯 목표
사용자가 **다양한 방식**으로 여행 목적지를 입력할 수 있어야 함.
- 도시명을 아는 경우: 직접 입력
- 도시명을 모르는 경우: 지도에서 선택
- 국가 일주 / 다국가 투어: AI가 최적 경로 제안

---

### 📋 목적지 유형

| 유형 | 예시 | 처리 방식 |
|------|------|----------|
| **단일 도시** | 파리 5일 | 기존 방식 (해당 도시 내 장소 추천) |
| **국가 일주** | 이탈리아 일주 7일 | AI가 최적 도시 선정 (로마→피렌체→베니스) |
| **다국가 투어** | 이탈리아, 스위스, 프랑스 10일 | AI가 국가별 핵심 도시 + 이동 경로 최적화 |
| **지역 투어** | 남프랑스 5일 | AI가 지역 내 핵심 도시 선정 (니스→칸→마르세유) |

---

### 🗺️ 경로 빌더 UX (Google Maps 스타일)

#### UI 레이아웃
```
┌─────────────────────────────────────────────────────┐
│  🗺️ 여행 경로 설정                                   │
├─────────────────────────────────────────────────────┤
│                                                     │
│  🟢 출발지: [인천공항 ▼]  (디폴트: 사용자 위치)       │
│      │                                              │
│      ├──────────────────────────────────────────    │
│      │                                              │
│  📍 경유 1: [로마, 이탈리아    ] [✕] [≡ 드래그]      │
│      │      2일 체류                                │
│      ├──────────────────────────────────────────    │
│      │                                              │
│  📍 경유 2: [피렌체, 이탈리아  ] [✕] [≡ 드래그]      │
│      │      1일 체류                                │
│      ├──────────────────────────────────────────    │
│      │                                              │
│  📍 경유 3: [베니스, 이탈리아  ] [✕] [≡ 드래그]      │
│      │      2일 체류                                │
│      ├──────────────────────────────────────────    │
│      │                                              │
│  [+ 경유지 추가]                                     │
│      │                                              │
│      ├──────────────────────────────────────────    │
│      │                                              │
│  🔴 도착지: [○ 출발지와 동일 (왕복)]                 │
│             [○ 다른 곳 (편도): _________ ]          │
│                                                     │
├─────────────────────────────────────────────────────┤
│  입력 방식:                                          │
│  [🔤 직접 입력]  [🗺️ 지도에서 선택]  [🤖 AI 추천]    │
└─────────────────────────────────────────────────────┘
```

#### 인터랙티브 지도 선택 모드
```
┌─────────────────────────────────────────────────────┐
│  🗺️ 지도에서 경유지 선택                             │
├─────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────┐│
│  │                                                 ││
│  │         [인터랙티브 Google Map]                 ││
│  │                                                 ││
│  │    📍 탭하여 경유지 추가                        ││
│  │    🔢 탭한 순서대로 경로 생성                   ││
│  │    ↔️ 줌/패닝으로 원하는 지역 탐색              ││
│  │                                                 ││
│  │    [1]로마  ─── [2]피렌체 ─── [3]베니스        ││
│  │                                                 ││
│  └─────────────────────────────────────────────────┘│
│                                                     │
│  선택된 경유지: [로마 ✕] [피렌체 ✕] [베니스 ✕]      │
│                                                     │
│  [경로 확정]                      [초기화]          │
└─────────────────────────────────────────────────────┘
```

#### AI 추천 모드 (처음 가는 여행지)
```
┌─────────────────────────────────────────────────────┐
│  🤖 AI에게 여행지 추천받기                           │
├─────────────────────────────────────────────────────┤
│                                                     │
│  어떤 여행을 원하세요?                               │
│  ┌─────────────────────────────────────────────────┐│
│  │ 이탈리아 미식 여행 7일                           ││
│  └─────────────────────────────────────────────────┘│
│                                                     │
│  AI 추천 경로:                                       │
│  ┌─────────────────────────────────────────────────┐│
│  │ 🇮🇹 이탈리아 미식 투어 (7일)                     ││
│  │                                                 ││
│  │ Day 1-2: 로마 (카르보나라의 본고장)              ││
│  │ Day 3-4: 피렌체 (티본 스테이크)                  ││
│  │ Day 5-6: 볼로냐 (볼로네제 파스타)                ││
│  │ Day 7: 밀라노 (리조또)                           ││
│  │                                                 ││
│  │ [이 경로로 시작]  [다시 추천받기]                ││
│  └─────────────────────────────────────────────────┘│
│                                                     │
└─────────────────────────────────────────────────────┘
```

---

### 💱 환율 시스템

#### 요구사항
- **디폴트 통화**: 한국 원화 (KRW)
- **실시간 환율**: 모든 통화 지원 (150+ 통화)
- **사용자 설정**: 선호 통화 선택 가능
- **일별 합계**: 원화 + 선택 통화 동시 표시

#### 지원 통화 (주요)
| 코드 | 통화 | 기호 |
|------|------|------|
| KRW | 한국 원 (디폴트) | ₩ |
| USD | 미국 달러 | $ |
| EUR | 유로 | € |
| JPY | 일본 엔 | ¥ |
| GBP | 영국 파운드 | £ |
| CNY | 중국 위안 | ¥ |
| THB | 태국 바트 | ฿ |
| VND | 베트남 동 | ₫ |

#### 환율 표시 UI
```
┌────────────────────────────────────────────┐
│ 📅 Day 1 예산 합계                          │
├────────────────────────────────────────────┤
│ 🎫 콜로세움 입장료          €16.00         │
│ 🍝 점심 - 카르보나라        €15.00         │
│ 🚕 택시 이동               €12.00         │
│ 🍷 저녁 - 트라토리아        €45.00         │
├────────────────────────────────────────────┤
│ 💶 Day 1 합계: €88.00                      │
│ 💴 원화 환산: ₩128,480                     │
│ 💹 환율: 1 EUR = ₩1,460 (01/05 10:30 기준) │
│    [🔄 환율 새로고침]                       │
└────────────────────────────────────────────┘
```

#### 프로필 통화 설정
```
┌────────────────────────────────────────────┐
│ ⚙️ 통화 설정                                │
├────────────────────────────────────────────┤
│ 기본 통화: [한국 원 (KRW) ▼]                │
│ 보조 통화: [미국 달러 (USD) ▼]              │
│                                            │
│ ☑️ 현지 통화로 가격 표시                    │
│ ☑️ 원화 환산 항상 표시                      │
│ ☐ 보조 통화도 함께 표시                    │
└────────────────────────────────────────────┘
```

#### 환율 API 연동
```
[Exchange Rate API]
    │
    ├── GET /latest?base=KRW
    │   → 모든 통화 대비 원화 환율
    │
    ├── 캐싱: 1시간 (실시간 반영)
    │
    └── Fallback: 마지막 저장된 환율 사용
```

---

### 🗄️ 추가 DB 스키마

```sql
-- 사용자 통화 설정 테이블
CREATE TABLE user_currency_settings (
  id SERIAL PRIMARY KEY,
  user_id VARCHAR(50),
  primary_currency VARCHAR(10) DEFAULT 'KRW',
  secondary_currency VARCHAR(10) DEFAULT 'USD',
  show_local_currency BOOLEAN DEFAULT TRUE,
  show_primary_always BOOLEAN DEFAULT TRUE,
  show_secondary BOOLEAN DEFAULT FALSE,
  updated_at TIMESTAMP DEFAULT NOW()
);

-- 환율 캐시 테이블
CREATE TABLE exchange_rates (
  id SERIAL PRIMARY KEY,
  base_currency VARCHAR(10) DEFAULT 'KRW',
  target_currency VARCHAR(10) NOT NULL,
  rate DECIMAL(15,6) NOT NULL,
  fetched_at TIMESTAMP DEFAULT NOW()
);

-- 여행 경로 테이블
CREATE TABLE trip_routes (
  id SERIAL PRIMARY KEY,
  user_id VARCHAR(50),
  trip_name VARCHAR(200),
  departure_location VARCHAR(200),
  return_to_departure BOOLEAN DEFAULT TRUE,
  arrival_location VARCHAR(200),
  total_days INTEGER,
  created_at TIMESTAMP DEFAULT NOW()
);

-- 경유지 테이블
CREATE TABLE trip_waypoints (
  id SERIAL PRIMARY KEY,
  route_id INTEGER REFERENCES trip_routes(id),
  order_index INTEGER NOT NULL,
  city_name VARCHAR(200) NOT NULL,
  country_name VARCHAR(200),
  country_code VARCHAR(10),
  latitude DECIMAL(10,7),
  longitude DECIMAL(10,7),
  stay_days INTEGER DEFAULT 1,
  created_at TIMESTAMP DEFAULT NOW()
);
```

---

### ✅ 구현 순서 (1.1 사용자 입력 시스템)

| 단계 | 태스크 | 예상 시간 | 의존성 |
|------|--------|----------|--------|
| 1 | 경로 빌더 UI 컴포넌트 | 2시간 | 없음 |
| 2 | 인터랙티브 지도 경유지 선택 연동 | 1시간 | Step 1, 기존 InteractiveMap |
| 3 | 목적지 유형 선택 (도시/국가/다국가) | 1시간 | Step 1 |
| 4 | AI 경로 추천 서비스 | 2시간 | Gemini 연동 |
| 5 | 환율 API 연동 (Exchange Rate API) | 1시간 | API 키 |
| 6 | 통화 설정 UI (프로필) | 30분 | Step 5 |
| 7 | 일별 합계 환율 적용 | 1시간 | Step 5, 6 |
| 8 | DB 스키마 추가 (경로, 경유지, 환율) | 30분 | 없음 |

**총 예상 시간: 약 9시간**

---

### 1.2 Vibe Score 표시 ⬜ 미완료

| 태스크 | 상태 | 설명 |
|--------|------|------|
| 장소 카드에 Vibe 배지 | ⬜ | 8+: 보라, 5-7: 주황, <5: 회색 |
| 점수 상세 뷰 | ⬜ | Vibe/Buzz/Taste 개별 점수 표시 |
| 홈 화면 Vibe 입력 | ⬜ | 오늘의 기분 선택 → AI 추천 |

---

## ⭐ 1.2.1 Vibe Score 표시 상세 계획

### 🎯 목표
VibeTrip의 핵심 점수 시스템을 사용자에게 **직관적**으로 표시.
단순 숫자가 아닌, 감성적이고 시각적인 표현으로 차별화.

---

### 📊 점수 체계 정리

| 점수 유형 | 범위 | 설명 | 가중치 |
|----------|------|------|--------|
| **Vibe Score** | 0-10 | Gemini Vision 분석 (사진 분위기, 조명, 구도) | 40% |
| **Buzz Score** | 0-10 | 인기도 (Google + TripAdvisor + 블로그 언급) | 30% |
| **Taste Score** | 0-10 | 맛 검증 (원어민 리뷰 비율, 미슐랭) | 30% |
| **Reality Penalty** | 0-5 | 현실 감점 (날씨, 혼잡도, 파업) | 차감 |

**최종 점수 = (Vibe × 0.4 + Buzz × 0.3 + Taste × 0.3) - Reality Penalty**

---

### 🎨 Vibe 배지 디자인

#### 색상 레벨
| 점수 범위 | 레벨 | 색상 | 배지 |
|----------|------|------|------|
| 8.0 - 10.0 | Excellent | 보라 (#8B5CF6) | ⭐ Vibe 8.5 |
| 5.0 - 7.9 | Good | 주황 (#F97316) | ⭐ Vibe 6.2 |
| 0.0 - 4.9 | Average | 회색 (#6B7280) | ⭐ Vibe 3.8 |

#### 배지 UI 컴포넌트
```
┌─────────────────────────────────────────┐
│  Excellent (8+)                         │
│  ┌─────────────────┐                    │
│  │ ⭐ Vibe 8.5     │  ← 보라색 배경     │
│  └─────────────────┘                    │
│                                         │
│  Good (5-7.9)                           │
│  ┌─────────────────┐                    │
│  │ ⭐ Vibe 6.2     │  ← 주황색 배경     │
│  └─────────────────┘                    │
│                                         │
│  Average (<5)                           │
│  ┌─────────────────┐                    │
│  │ ⭐ Vibe 3.8     │  ← 회색 배경       │
│  └─────────────────┘                    │
└─────────────────────────────────────────┘
```

---

### 📋 점수 상세 뷰 UI

#### 장소 카드 클릭 시 상세 점수 표시
```
┌────────────────────────────────────────────────────┐
│ 🍜 광장시장 육회골목                                 │
├────────────────────────────────────────────────────┤
│                                                    │
│  📊 점수 상세                                       │
│  ┌────────────────────────────────────────────────┐│
│  │                                                ││
│  │  ⭐ 최종 Vibe Score: 8.5                       ││
│  │  ════════════════════════════════════════      ││
│  │                                                ││
│  │  🎨 Vibe (분위기)     ████████░░ 8.2           ││
│  │     → "따뜻한 조명, 활기찬 시장 분위기"          ││
│  │                                                ││
│  │  🔥 Buzz (인기도)     █████████░ 9.0           ││
│  │     → Google 4.5 / TripAdvisor 4.7 / 블로그 152 ││
│  │                                                ││
│  │  👅 Taste (맛)        ████████░░ 8.3           ││
│  │     → 한국어 리뷰 85% / 미슐랭 빕구르망          ││
│  │                                                ││
│  │  ⚠️ Reality Penalty   -0.5                     ││
│  │     → 주말 혼잡 예상                            ││
│  │                                                ││
│  └────────────────────────────────────────────────┘│
│                                                    │
│  📺 유튜버 Pick                                     │
│  ┌────────────────────────────────────────────────┐│
│  │ 성시경 - "인생 국물" (12:30)                    ││
│  │ 백종원 - "육회 맛집 인정" (8:45)                 ││
│  └────────────────────────────────────────────────┘│
│                                                    │
└────────────────────────────────────────────────────┘
```

---

### 🌈 홈 화면 Vibe 입력 (오늘의 기분)

#### UI 레이아웃
```
┌────────────────────────────────────────────────────┐
│                                                    │
│  오늘 어떤 분위기가 끌리세요?                        │
│                                                    │
│  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐      │
│  │ 🌅     │ │ 🍷     │ │ 🎉     │ │ 🧘     │      │
│  │ 로맨틱 │ │ 럭셔리 │ │ 활기찬 │ │ 힐링   │      │
│  └────────┘ └────────┘ └────────┘ └────────┘      │
│                                                    │
│  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐      │
│  │ 🏛️     │ │ 🍜     │ │ 📸     │ │ 🌿     │      │
│  │ 역사적 │ │ 로컬   │ │ 인스타 │ │ 자연   │      │
│  └────────┘ └────────┘ └────────┘ └────────┘      │
│                                                    │
│  선택된 Vibe: [로맨틱] [럭셔리]                     │
│                                                    │
│  [✨ AI 추천 받기]                                  │
│                                                    │
└────────────────────────────────────────────────────┘
```

#### Vibe 카테고리 정의
| Vibe | 코드 | AI 프롬프트 키워드 |
|------|------|-------------------|
| 🌅 로맨틱 | romantic | 야경, 분위기, 커플, 조용한 |
| 🍷 럭셔리 | luxury | 미슐랭, 프리미엄, 서비스, 예약 |
| 🎉 활기찬 | lively | 시장, 술집, 클럽, 축제 |
| 🧘 힐링 | relaxing | 스파, 공원, 카페, 느긋한 |
| 🏛️ 역사적 | historic | 박물관, 유적, 건축, 문화 |
| 🍜 로컬 | local | 현지인, 숨은, 골목, 맛집 |
| 📸 인스타 | instagrammable | 포토, 뷰, 예쁜, 핫플 |
| 🌿 자연 | nature | 트레킹, 바다, 산, 공원 |

#### Vibe → 장소 추천 로직
```typescript
// server/services/vibe-recommender.ts
export async function getVibeRecommendations(
  cityId: number,
  vibes: string[], // ['romantic', 'luxury']
  persona: 'luxury' | 'comfort'
): Promise<Place[]> {
  // 1. Vibe 가중치 계산
  const vibeWeights = calculateVibeWeights(vibes);
  
  // 2. 장소별 Vibe 매칭 점수 계산
  const places = await db.query.places.findMany({
    where: eq(places.cityId, cityId)
  });
  
  // 3. AI 분석으로 장소-Vibe 매칭
  const scored = await Promise.all(
    places.map(async (place) => {
      const vibeMatch = await analyzeVibeMatch(place, vibes);
      return { place, vibeMatch };
    })
  );
  
  // 4. 상위 N개 반환
  return scored
    .sort((a, b) => b.vibeMatch - a.vibeMatch)
    .slice(0, 10)
    .map(s => s.place);
}
```

---

### ✅ 구현 순서 (1.2 Vibe Score 표시)

| 단계 | 태스크 | 예상 시간 | 의존성 |
|------|--------|----------|--------|
| 1 | VibeBadge 컴포넌트 | 30분 | 없음 |
| 2 | 장소 카드에 배지 적용 | 30분 | Step 1 |
| 3 | 점수 상세 뷰 컴포넌트 | 1시간 | Step 1 |
| 4 | 점수 상세 모달/시트 | 30분 | Step 3 |
| 5 | Vibe 선택 UI (홈 화면) | 1시간 | 없음 |
| 6 | Vibe → 추천 API 연동 | 1시간 | Step 5 |
| 7 | 프로그레스 바 애니메이션 | 30분 | Step 3 |

**총 예상 시간: 약 5시간**

---

### 1.3 성능 최적화 ⬜ 미완료

| 태스크 | 상태 | 설명 |
|--------|------|------|
| React.memo 적용 | ⬜ | 불필요한 리렌더링 방지 |
| useMemo/useCallback | ⬜ | 계산 최적화 |
| 이미지 최적화 | ⬜ | expo-image 캐싱 활용 |

---

## ⚡ 1.3.1 성능 최적화 상세 계획

### 🎯 목표
- 앱 로딩 시간 50% 단축
- 스크롤 60fps 유지
- 메모리 사용량 최소화
- 배터리 소모 감소

---

### 📊 현재 성능 이슈 분석

| 이슈 | 원인 | 영향 | 우선순위 |
|------|------|------|----------|
| 느린 초기 로딩 | 모든 데이터 한번에 fetch | UX 저하 | 🔴 높음 |
| 스크롤 버벅임 | 불필요한 리렌더링 | 60fps 미달 | 🔴 높음 |
| 이미지 지연 | 캐싱 미적용 | 시각적 지연 | 🟡 중간 |
| 메모리 누수 | 이벤트 리스너 미정리 | 앱 크래시 | 🟡 중간 |

---

### 🔧 최적화 전략

#### 1. React.memo 적용
```typescript
// 최적화 전
export function PlaceCard({ place }: Props) {
  return <View>...</View>;
}

// 최적화 후
export const PlaceCard = React.memo(function PlaceCard({ place }: Props) {
  return <View>...</View>;
}, (prevProps, nextProps) => {
  return prevProps.place.id === nextProps.place.id &&
         prevProps.place.vibeScore === nextProps.place.vibeScore;
});
```

**적용 대상 컴포넌트:**
- `PlaceCard` - 장소 카드
- `DayCard` - 일정 카드
- `VibeBadge` - 점수 배지
- `MapMarker` - 지도 마커
- `ItineraryItem` - 일정 항목

#### 2. useMemo/useCallback 최적화
```typescript
// 최적화 전
const sortedPlaces = places.sort((a, b) => b.vibeScore - a.vibeScore);

// 최적화 후
const sortedPlaces = useMemo(() => 
  places.sort((a, b) => b.vibeScore - a.vibeScore),
  [places]
);

// 콜백 최적화
const handlePlacePress = useCallback((place: Place) => {
  navigation.navigate('PlaceDetail', { placeId: place.id });
}, [navigation]);
```

**적용 대상:**
- 장소 정렬/필터링 로직
- 점수 계산 로직
- 이벤트 핸들러
- 스타일 계산

#### 3. 이미지 최적화 (expo-image)
```typescript
import { Image } from 'expo-image';

// 최적화된 이미지 컴포넌트
<Image
  source={{ uri: place.photoUrl }}
  style={styles.image}
  contentFit="cover"
  placeholder={blurhash}
  transition={200}
  cachePolicy="memory-disk"
/>
```

**expo-image 장점:**
- 자동 캐싱 (메모리 + 디스크)
- 블러해시 플레이스홀더
- 부드러운 전환 애니메이션
- WebP/AVIF 자동 최적화

#### 4. FlatList 최적화
```typescript
<FlatList
  data={places}
  renderItem={renderPlaceCard}
  keyExtractor={(item) => item.id.toString()}
  // 성능 최적화 옵션
  removeClippedSubviews={true}
  maxToRenderPerBatch={10}
  windowSize={5}
  initialNumToRender={10}
  getItemLayout={(data, index) => ({
    length: CARD_HEIGHT,
    offset: CARD_HEIGHT * index,
    index,
  })}
/>
```

#### 5. 데이터 페이지네이션
```typescript
// API 페이지네이션
GET /api/places?cityId=1&page=1&limit=20

// React Query 무한 스크롤
const { data, fetchNextPage, hasNextPage } = useInfiniteQuery({
  queryKey: ['places', cityId],
  queryFn: ({ pageParam = 1 }) => 
    fetchPlaces(cityId, pageParam),
  getNextPageParam: (lastPage) => lastPage.nextPage,
});
```

#### 6. 번들 사이즈 최적화
```javascript
// 동적 임포트
const MapView = React.lazy(() => import('./MapView'));

// 조건부 로딩
{showMap && (
  <Suspense fallback={<MapSkeleton />}>
    <MapView />
  </Suspense>
)}
```

---

### 📱 성능 모니터링

#### 개발 중 모니터링
```typescript
// React DevTools Profiler 사용
// 렌더링 시간, 리렌더링 원인 분석

// Flipper 연동 (네이티브 디버깅)
// 네트워크, 레이아웃, 성능 분석
```

#### 성능 목표
| 지표 | 현재 | 목표 |
|------|------|------|
| 초기 로딩 | ~3초 | <1.5초 |
| 스크롤 FPS | 45-50 | 60 |
| 메모리 사용 | ~200MB | <150MB |
| 이미지 로딩 | ~500ms | <100ms (캐시) |

---

### ✅ 구현 순서 (1.3 성능 최적화)

| 단계 | 태스크 | 예상 시간 | 의존성 |
|------|--------|----------|--------|
| 1 | 주요 컴포넌트 React.memo 적용 | 1시간 | 없음 |
| 2 | useMemo/useCallback 리팩토링 | 1시간 | 없음 |
| 3 | expo-image 마이그레이션 | 30분 | 없음 |
| 4 | FlatList 최적화 옵션 적용 | 30분 | 없음 |
| 5 | API 페이지네이션 구현 | 1시간 | 백엔드 |
| 6 | 번들 사이즈 분석 및 최적화 | 30분 | Step 1-5 |
| 7 | 성능 테스트 및 검증 | 30분 | Step 1-6 |

**총 예상 시간: 약 5시간**

---

### 1.4 데이터 연동 ⬜ 미완료

| 태스크 | 상태 | 설명 |
|--------|------|------|
| Google Maps API 키 설정 | ⬜ | 실제 장소 데이터 연동 |
| OpenWeather API 키 설정 | ⬜ | 날씨 데이터 연동 |
| 샘플 데이터 → 실제 데이터 | ⬜ | API 연동 완료 후 전환 |

---

## 🔗 1.4.0 데이터 연동 상세 계획

### 🎯 목표
모든 외부 API를 안전하게 연동하고, 샘플 데이터에서 실제 데이터로 전환.
API 키 관리, 에러 처리, 폴백 로직을 체계적으로 구현.

---

### 🔑 필요한 API 키 목록

| API | 환경변수 | 용도 | 무료 한도 | 상태 |
|-----|----------|------|----------|------|
| **Google Maps** | `GOOGLE_MAPS_API_KEY` | 장소, 사진, 경로 | $200/월 크레딧 | ⬜ 필요 |
| **OpenWeather** | `OPENWEATHER_API_KEY` | 날씨 현재/예보 | 1,000 콜/일 | ⬜ 필요 |
| **YouTube Data** | `YOUTUBE_DATA_API_KEY` | 영상, 자막 수집 | 10,000 쿼터/일 | ⬜ 필요 |
| **Exchange Rate** | `EXCHANGE_RATE_API_KEY` | 실시간 환율 | 1,500 콜/월 | ⬜ 필요 |
| **Gemini AI** | `AI_INTEGRATIONS_GEMINI_API_KEY` | AI 분석 | 연동됨 | ✅ 완료 |

---

### 🗺️ Google Maps API 연동

#### 필요한 API 서비스
| 서비스 | 용도 | 예상 호출/일 |
|--------|------|-------------|
| Places API (New) | 장소 검색, 상세정보 | ~500 |
| Places Photos | 장소 사진 | ~1,000 |
| Geocoding API | 주소 ↔ 좌표 변환 | ~100 |
| Routes API | 경로 계산, 거리/시간 | ~200 |
| Maps JavaScript API | 인터랙티브 지도 | 무제한 (클라이언트) |

#### 서버 구현 예시
```typescript
// server/services/google-places.ts
import { Client } from '@googlemaps/google-maps-services-js';

const client = new Client({});

export async function searchPlaces(query: string, location: { lat: number; lng: number }) {
  try {
    const response = await client.textSearch({
      params: {
        query,
        location,
        radius: 5000,
        key: process.env.GOOGLE_MAPS_API_KEY!,
      },
    });
    return response.data.results;
  } catch (error) {
    console.error('Google Places API error:', error);
    // Gemini 폴백
    return await searchPlacesWithGemini(query, location);
  }
}
```

#### 보안 설정 (Google Cloud Console)
1. API 키 제한 (Application restrictions)
   - HTTP referrers: `*.replit.app`, `localhost:*`
   - IP addresses: 서버 IP 화이트리스트
2. API 제한 (API restrictions)
   - Places API, Geocoding API, Routes API만 허용
3. 할당량 설정
   - 일일 한도 설정으로 과금 방지

---

### 🌤️ OpenWeather API 연동

#### 사용할 API 엔드포인트
| 엔드포인트 | 용도 | 업데이트 주기 |
|-----------|------|--------------|
| `/weather` | 현재 날씨 | 실시간 |
| `/forecast` | 5일 예보 (3시간 단위) | 3시간 |
| `/onecall` | 7일 예보 + 시간별 | 1시간 |

#### 서버 구현 예시
```typescript
// server/services/weather.ts
export async function getWeather(lat: number, lon: number) {
  const apiKey = process.env.OPENWEATHER_API_KEY;
  
  // 캐시 확인 (1시간)
  const cached = await getCachedWeather(lat, lon);
  if (cached && !isExpired(cached, 3600)) {
    return cached;
  }
  
  try {
    const response = await fetch(
      `https://api.openweathermap.org/data/2.5/onecall?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric&lang=kr`
    );
    const data = await response.json();
    
    // 캐시 저장
    await cacheWeather(lat, lon, data);
    
    return {
      current: {
        temp: data.current.temp,
        feelsLike: data.current.feels_like,
        description: data.current.weather[0].description,
        icon: data.current.weather[0].icon,
      },
      daily: data.daily.map(d => ({
        date: new Date(d.dt * 1000),
        tempMin: d.temp.min,
        tempMax: d.temp.max,
        description: d.weather[0].description,
        icon: d.weather[0].icon,
        pop: d.pop, // 강수 확률
      })),
      alerts: data.alerts || [],
    };
  } catch (error) {
    console.error('OpenWeather API error:', error);
    return null;
  }
}
```

#### Reality Penalty 계산
```typescript
export function calculateWeatherPenalty(weather: Weather): number {
  let penalty = 0;
  
  // 기온 페널티
  if (weather.temp < 0 || weather.temp > 35) penalty += 1.0;
  else if (weather.temp < 5 || weather.temp > 30) penalty += 0.5;
  
  // 강수 페널티
  if (weather.pop > 0.7) penalty += 1.0;  // 70% 이상
  else if (weather.pop > 0.4) penalty += 0.5;
  
  // 기상 경보 페널티
  if (weather.alerts?.length > 0) {
    const severe = weather.alerts.some(a => 
      a.event.includes('경보') || a.event.includes('warning')
    );
    penalty += severe ? 1.5 : 0.5;
  }
  
  return Math.min(penalty, 3.0); // 최대 3점 감점
}
```

---

### 📺 YouTube Data API 연동

#### 쿼터 관리 (10,000/일)
| 작업 | 쿼터 비용 | 예상 사용 |
|------|----------|----------|
| search.list | 100 | ~50회/일 |
| videos.list | 1 | ~500회/일 |
| captions.list | 50 | ~100회/일 |
| captions.download | 200 | ~20회/일 |

#### 채널별 영상 수집
```typescript
// server/services/youtube-collector.ts
export async function collectChannelVideos(channelId: string, maxResults: number = 10) {
  const apiKey = process.env.YOUTUBE_DATA_API_KEY;
  
  // 1. 채널의 최신 영상 검색
  const searchResponse = await fetch(
    `https://www.googleapis.com/youtube/v3/search?` +
    `part=snippet&channelId=${channelId}&order=date&maxResults=${maxResults}&type=video&key=${apiKey}`
  );
  const searchData = await searchResponse.json();
  
  // 2. 영상 상세 정보 가져오기
  const videoIds = searchData.items.map(item => item.id.videoId).join(',');
  const videosResponse = await fetch(
    `https://www.googleapis.com/youtube/v3/videos?` +
    `part=snippet,contentDetails,statistics&id=${videoIds}&key=${apiKey}`
  );
  const videosData = await videosResponse.json();
  
  // 3. 자막 추출 (Gemini로 분석)
  for (const video of videosData.items) {
    const transcript = await extractTranscript(video.id);
    const places = await extractPlacesFromTranscript(transcript, video.snippet.title);
    await saveVideoPlaceMentions(video, places);
  }
  
  return videosData.items;
}
```

---

### 💱 Exchange Rate API 연동

#### 무료 API 옵션
| 서비스 | 무료 한도 | 업데이트 주기 |
|--------|----------|--------------|
| exchangerate-api.com | 1,500 콜/월 | 매일 |
| openexchangerates.org | 1,000 콜/월 | 매일 |
| fixer.io | 100 콜/월 | 매일 |

#### 서버 구현
```typescript
// server/services/exchange-rate.ts
const CACHE_DURATION = 3600 * 1000; // 1시간
let rateCache: { rates: Record<string, number>; timestamp: number } | null = null;

export async function getExchangeRates(base: string = 'KRW'): Promise<Record<string, number>> {
  // 캐시 확인
  if (rateCache && Date.now() - rateCache.timestamp < CACHE_DURATION) {
    return rateCache.rates;
  }
  
  try {
    const response = await fetch(
      `https://v6.exchangerate-api.com/v6/${process.env.EXCHANGE_RATE_API_KEY}/latest/${base}`
    );
    const data = await response.json();
    
    rateCache = {
      rates: data.conversion_rates,
      timestamp: Date.now(),
    };
    
    // DB에도 저장 (폴백용)
    await saveRatesToDB(data.conversion_rates);
    
    return data.conversion_rates;
  } catch (error) {
    console.error('Exchange Rate API error:', error);
    // DB에서 마지막 환율 가져오기
    return await getLastRatesFromDB();
  }
}

export function convertCurrency(
  amount: number,
  fromCurrency: string,
  toCurrency: string,
  rates: Record<string, number>
): number {
  if (fromCurrency === toCurrency) return amount;
  
  // KRW 기준이면 직접 변환
  if (fromCurrency === 'KRW') {
    return amount / rates[toCurrency];
  }
  if (toCurrency === 'KRW') {
    return amount * rates[fromCurrency];
  }
  
  // 다른 통화 간 변환 (KRW 경유)
  const krwAmount = amount * rates[fromCurrency];
  return krwAmount / rates[toCurrency];
}
```

---

### 🔄 샘플 데이터 → 실제 데이터 전환

#### 전환 체크리스트
| 화면 | 현재 | 전환 후 | 상태 |
|------|------|---------|------|
| 홈 (Discover) | 하드코딩 도시 | DB + API | ⬜ |
| 지도 (Map) | 샘플 마커 | Google Places | ⬜ |
| 일정 (Plan) | Gemini 생성 | Google + Gemini | ⬜ |
| 프로필 (Profile) | Mock 데이터 | 로컬 스토리지 | ⬜ |

#### 폴백 전략
```
[API 호출]
    │
    ├── 성공 → 데이터 반환 + 캐시 저장
    │
    └── 실패
         │
         ├── 캐시 있음 → 캐시 데이터 반환
         │
         └── 캐시 없음
              │
              ├── Gemini 폴백 가능 → Gemini로 생성
              │
              └── 최종 실패 → 에러 메시지 표시
```

---

### ✅ 구현 순서 (1.4 데이터 연동)

| 단계 | 태스크 | 예상 시간 | 의존성 |
|------|--------|----------|--------|
| 1 | API 키 환경변수 설정 | 30분 | API 키 발급 |
| 2 | Google Places 서비스 완성 | 1시간 | Step 1 |
| 3 | OpenWeather 서비스 완성 | 30분 | Step 1 |
| 4 | Exchange Rate 서비스 구현 | 30분 | Step 1 |
| 5 | 캐싱 레이어 구현 | 1시간 | Step 2-4 |
| 6 | 폴백 로직 구현 | 30분 | Step 2-5 |
| 7 | 홈 화면 실제 데이터 연동 | 1시간 | Step 2 |
| 8 | 지도 화면 실제 데이터 연동 | 1시간 | Step 2 |
| 9 | 일정 화면 실제 데이터 연동 | 30분 | Step 2 |
| 10 | 에러 처리 및 사용자 피드백 | 30분 | Step 7-9 |

**총 예상 시간: 약 7시간**

---

## 📊 1.4.1 다중 소스 데이터 수집 상세 계획

### 🎯 목표
VibeTrip의 핵심 차별화는 **다중 소스 로우 데이터 기반 신뢰도**입니다.
단순 Google Maps 래퍼가 아닌, 여러 소스를 분석하여 감성(Vibe) 기반 추천을 제공합니다.

---

### 📋 수집 데이터 소스 목록

| 순서 | 소스명 | 데이터 유형 | API/방법 | 우선순위 |
|------|--------|-------------|----------|----------|
| 1 | **Google Places** | 장소 기본정보, 평점, 리뷰, 사진 | Google Places API | 🔴 필수 |
| 2 | **YouTube 검증 채널** | 영상 자막, 타임스탬프, 리뷰 | YouTube Data API v3 | 🔴 필수 |
| 3 | **블로그/리뷰** | 네이버/티스토리/TripAdvisor 리뷰 | Gemini Web Search | 🔴 필수 |
| 4 | **미슐랭 가이드** | 별점, 추천 카테고리 | Gemini Web Search | 🟡 중요 |
| 5 | **날씨/기후** | 현재/예보, 기상 경보 | OpenWeather API | 🟡 중요 |
| 6 | **위기 정보** | 파업, 시위, 교통 장애 | GDELT/NewsAPI + Gemini | 🟡 중요 |
| 7 | **가격 정보** | 입장료, 예상 식사비, 교통비 | Google Places + Gemini | 🟡 중요 |
| 8 | **환율** | 실시간 환율 | Exchange Rate API | 🟢 향후 |
| 9 | **예약 가능성** | OpenTable, Klook 재고 | 각 API | 🟢 향후 |

---

### ⏰ 수집 스케줄

```
┌─────────────────────────────────────────────────────────────────┐
│                    자동 수집 스케줄 (KST 기준)                    │
├─────────────────────────────────────────────────────────────────┤
│  새벽 3:00  │  YouTube 채널 신규 영상 + 자막 수집                │
│  새벽 3:15  │  Gemini Web Search (블로그/미슐랭/TripAdvisor)    │
│  새벽 3:30  │  위기 정보 수집 (파업/시위/교통장애)               │
│  새벽 3:45  │  가격 정보 업데이트 (입장료/식사비)                │
│  새벽 4:00  │  환율 정보 업데이트                               │
│  새벽 4:15  │  데이터 정합성 검증 + DB 저장                      │
│  새벽 4:30  │  수집 완료 로그 기록 (타임스탬프)                  │
└─────────────────────────────────────────────────────────────────┘
```

**선택 이유:** 새벽 3시(KST)는 한국 트래픽 최저점 + API 서버 부하 최소

---

### 🔄 처리 파이프라인

#### Step 1: YouTube 검증 채널 데이터
```
[채널 화이트리스트 DB] ← 관리자 대시보드에서 관리
    │
    ├── 🍽️ 맛집 채널: 성시경, 백종원, 최자로드
    ├── 🍷 미식/와인 채널: 비밀이야, 와인 마시는 아톰
    ├── ✈️ 여행 채널: 빠니보틀, 곽튜브, 원지의하루
    ├── 🌍 현지 채널: 파리외노자, CHUNG Haemi, 마키친 등
    └── 👤 사용자 추가 채널: 프로필에서 등록
    │
    ▼
[YouTube Data API v3]
    │
    ├── GET /search (채널 ID + "맛집" OR "여행")
    ├── GET /videos (영상 상세정보)
    └── GET /captions (자막 스크립트)
    │
    ▼
[Gemini AI 분석]
    │
    ├── 자막에서 장소명 추출 (Fuzzy Matching)
    ├── 타임스탬프 매핑 ("삼부자" → 12:30~15:45)
    ├── 감성 분석 (Positive/Negative/Neutral)
    └── 3줄 요약 생성
    │
    ▼
[DB 저장]
    │
    ├── place_id: 장소 연결
    ├── video_url: youtube.com/watch?v=xyz&t=345s
    ├── timestamp_start: 345
    ├── timestamp_end: 480
    ├── sentiment: "positive"
    ├── summary: "성시경이 '인생 국물'이라 극찬"
    └── collected_at: 2026-01-05 03:15:00
```

#### Step 2: Gemini Web Search 다중 소스
```
[Gemini AI - Web Search 모드]
    │
    ├── Query 1: "{장소명} 미슐랭 가이드 평가"
    ├── Query 2: "{장소명} TripAdvisor 리뷰"
    ├── Query 3: "{장소명} 네이버 블로그 후기"
    ├── Query 4: "{장소명} 인스타그램 인기"
    └── Query 5: "{장소명} 최신 영업 상태"
    │
    ▼
[데이터 구조화]
    │
    ├── michelin_rating: "1스타" / "빕구르망" / null
    ├── tripadvisor_rating: 4.5
    ├── blog_mention_count: 152
    ├── instagram_hashtag_count: 12500
    ├── is_open: true
    └── source_urls: [...]
    │
    ▼
[Vibe Score 계산]
    │
    ├── vibe_score: Gemini Vision 분석 결과
    ├── buzz_score: (Google + TripAdvisor + 블로그) / 3
    ├── taste_score: 원어민 리뷰 비율 가중치
    └── reality_penalty: 날씨 + 혼잡도 + 파업 정보
```

#### Step 3: 위기 정보 수집
```
[GDELT/NewsAPI + Gemini]
    │
    ├── 파업 정보: "파리 지하철 파업 2026-01-10"
    ├── 시위 정보: "노란조끼 시위 샹젤리제"
    ├── 날씨 경보: "폭우 경보 01/06 14:00-18:00"
    └── 교통 장애: "에펠탑 인근 도로 통제"
    │
    ▼
[Reality Check 반영]
    │
    ├── 해당 일정에 경고 표시
    ├── 대안 이동수단 제안 (우버/택시)
    └── 일정 자동 조정 옵션 제공
```

#### Step 4: 가격 정보 수집
```
[Google Places + Gemini]
    │
    ├── 입장료: Gemini Web Search
    ├── 식사 예상비: price_level → 금액 변환
    │   ├── $ (1): ~₩15,000
    │   ├── $$ (2): ~₩30,000
    │   ├── $$$ (3): ~₩60,000
    │   └── $$$$ (4): ~₩100,000+
    ├── 교통비: Google Routes API (택시/대중교통)
    └── 환율: Exchange Rate API
    │
    ▼
[일별 합계 계산]
    │
    ├── Day 1: ₩185,000 (약 $138)
    ├── Day 2: ₩142,000 (약 $106)
    └── 총 예상: ₩327,000 (약 $244)
```

---

### 🗄️ DB 스키마 추가 (필요)

```sql
-- YouTube 검증 채널 테이블
CREATE TABLE youtube_channels (
  id SERIAL PRIMARY KEY,
  channel_id VARCHAR(50) UNIQUE NOT NULL,
  channel_name VARCHAR(200) NOT NULL,
  category VARCHAR(50), -- 'mega_influencer', 'local_expert', 'user_added'
  is_active BOOLEAN DEFAULT TRUE,
  added_by VARCHAR(50), -- 'system' or user_id
  created_at TIMESTAMP DEFAULT NOW()
);

-- YouTube 영상-장소 매핑 테이블
CREATE TABLE youtube_place_mentions (
  id SERIAL PRIMARY KEY,
  place_id INTEGER REFERENCES places(id),
  channel_id VARCHAR(50),
  video_id VARCHAR(20) NOT NULL,
  video_title VARCHAR(500),
  timestamp_start INTEGER, -- 초 단위
  timestamp_end INTEGER,
  sentiment VARCHAR(20), -- 'positive', 'negative', 'neutral'
  summary TEXT,
  collected_at TIMESTAMP DEFAULT NOW()
);

-- 다중 소스 데이터 테이블
CREATE TABLE place_external_data (
  id SERIAL PRIMARY KEY,
  place_id INTEGER REFERENCES places(id),
  michelin_rating VARCHAR(20),
  tripadvisor_rating DECIMAL(2,1),
  tripadvisor_review_count INTEGER,
  blog_mention_count INTEGER,
  instagram_hashtag_count INTEGER,
  estimated_price_low INTEGER,
  estimated_price_high INTEGER,
  currency VARCHAR(10) DEFAULT 'KRW',
  source_urls JSONB,
  collected_at TIMESTAMP DEFAULT NOW()
);

-- 위기 정보 테이블
CREATE TABLE crisis_alerts (
  id SERIAL PRIMARY KEY,
  city_id INTEGER REFERENCES cities(id),
  alert_type VARCHAR(50), -- 'strike', 'protest', 'weather', 'traffic'
  title VARCHAR(500),
  description TEXT,
  affected_area VARCHAR(200),
  start_time TIMESTAMP,
  end_time TIMESTAMP,
  severity VARCHAR(20), -- 'low', 'medium', 'high', 'critical'
  alternative_suggestion TEXT,
  collected_at TIMESTAMP DEFAULT NOW()
);

-- 수집 로그 테이블
CREATE TABLE data_collection_logs (
  id SERIAL PRIMARY KEY,
  collection_type VARCHAR(50),
  status VARCHAR(20), -- 'started', 'completed', 'failed'
  items_collected INTEGER,
  error_message TEXT,
  started_at TIMESTAMP,
  completed_at TIMESTAMP
);
```

---

### 📱 UI 표시 계획

#### 장소 카드
```
┌────────────────────────────────────────────┐
│ 🍜 광장시장 육회골목                          │
│ ────────────────────────────────────────── │
│ ⭐ Vibe 8.5  │  📺 유튜버 Pick  │  🌟 빕구르망  │
│ ────────────────────────────────────────── │
│ 💰 예상: ₩15,000~25,000                     │
│ ────────────────────────────────────────── │
│ 📊 데이터 소스: Google, TripAdvisor, 블로그  │
│ 🕐 수집: 2026.01.05 03:15                   │
└────────────────────────────────────────────┘
```

#### 유튜버 Pick 상세
```
┌────────────────────────────────────────────┐
│ ▶️ [YouTube IFrame 임베드]                  │
│    (해당 시점 345초부터 자동 재생)            │
├────────────────────────────────────────────┤
│ 📺 성시경 - 먹을텐데                         │
│ "인생 국물이라고 극찬한 순간" (12:30~15:45)  │
└────────────────────────────────────────────┘
```

#### 일별 예산 합계
```
┌────────────────────────────────────────────┐
│ 📅 Day 1 예산 합계                          │
├────────────────────────────────────────────┤
│ 🎫 경복궁 입장료          ₩3,000           │
│ 🍜 점심 - 광장시장        ₩15,000          │
│ 🚕 택시 이동              ₩8,000           │
│ 🍽️ 저녁 - 명동교자        ₩12,000          │
├────────────────────────────────────────────┤
│ 💰 Day 1 합계: ₩38,000 (약 $28)           │
│ 💹 환율: 1 USD = ₩1,350 (01/05 기준)       │
└────────────────────────────────────────────┘
```

---

### 🛠️ 관리자 대시보드

#### 개요
관리자가 쉽게 데이터 소스를 **추가/수정/삭제**할 수 있는 대시보드.
코드 수정 없이 채널, 블로그, 평가 소스를 관리할 수 있어야 함.

#### 대시보드 UI 레이아웃
```
┌─────────────────────────────────────────────────────────────┐
│  🛠️ VibeTrip 관리자 대시보드                                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  📊 수집 현황                                                │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ 마지막 수집: 2026.01.05 03:15 KST                        ││
│  │ 수집된 장소: 1,234개  │  연결된 영상: 456개               ││
│  │ 오류: 0건  │  [수동 수집 실행]                            ││
│  └─────────────────────────────────────────────────────────┘│
│                                                             │
│  📺 YouTube 채널 관리                      [+ 채널 추가]     │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ 카테고리  │  채널명          │  상태   │  액션           ││
│  │─────────────────────────────────────────────────────────││
│  │ 🍽️ 맛집   │  성시경           │  ✅ 활성  │  [수정][삭제]  ││
│  │ 🍽️ 맛집   │  백종원           │  ✅ 활성  │  [수정][삭제]  ││
│  │ 🍽️ 맛집   │  최자로드         │  ✅ 활성  │  [수정][삭제]  ││
│  │ 🍷 미식   │  비밀이야         │  ✅ 활성  │  [수정][삭제]  ││
│  │ 🍷 미식   │  와인 마시는 아톰  │  ✅ 활성  │  [수정][삭제]  ││
│  │ ✈️ 여행   │  빠니보틀         │  ✅ 활성  │  [수정][삭제]  ││
│  │ ✈️ 여행   │  곽튜브           │  ✅ 활성  │  [수정][삭제]  ││
│  │ 🌍 현지   │  파리외노자       │  ✅ 활성  │  [수정][삭제]  ││
│  └─────────────────────────────────────────────────────────┘│
│                                                             │
│  📝 블로그/리뷰 소스 관리                   [+ 소스 추가]    │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ 유형      │  이름             │  상태   │  액션           ││
│  │─────────────────────────────────────────────────────────││
│  │ 🏆 미슐랭  │  Michelin Guide   │  ✅ 활성  │  [수정][삭제]  ││
│  │ ⭐ 리뷰   │  TripAdvisor      │  ✅ 활성  │  [수정][삭제]  ││
│  │ 📰 블로그  │  네이버 블로그     │  ✅ 활성  │  [수정][삭제]  ││
│  │ 📸 SNS    │  Instagram        │  ✅ 활성  │  [수정][삭제]  ││
│  └─────────────────────────────────────────────────────────┘│
│                                                             │
│  ⚙️ 수집 설정                                                │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ 자동 수집 시간: [03:00] KST                              ││
│  │ 수집 주기: [매일 ▼]                                      ││
│  │ 데이터 보관 기간: [30일 ▼]                                ││
│  └─────────────────────────────────────────────────────────┘│
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 채널 추가 모달
```
┌─────────────────────────────────────────┐
│  📺 YouTube 채널 추가                    │
├─────────────────────────────────────────┤
│  채널 URL 또는 ID:                       │
│  ┌─────────────────────────────────────┐│
│  │ https://youtube.com/@secret_food    ││
│  └─────────────────────────────────────┘│
│                                         │
│  채널명: [자동 입력됨]                   │
│  카테고리: [맛집 ▼]                      │
│                                         │
│  [취소]                    [추가]       │
└─────────────────────────────────────────┘
```

#### 채널 카테고리
| 카테고리 | 코드 | 설명 |
|---------|------|------|
| 🍽️ 맛집 | `food` | 일반 맛집 리뷰 (성시경, 백종원) |
| 🍷 미식/와인 | `gourmet` | 고급 미식, 와인 페어링 (비밀이야, 와인 마시는 아톰) |
| ✈️ 여행 | `travel` | 여행 브이로그 (빠니보틀, 곽튜브) |
| 🌍 현지 | `local` | 현지 거주자/전문가 (파리외노자) |
| 👤 사용자 | `user_added` | 사용자가 직접 추가한 채널 |

#### 기본 등록 채널 목록 (시드 데이터)

| 카테고리 | 채널명 | YouTube ID | 구독자 |
|---------|--------|------------|--------|
| 🍽️ 맛집 | 성시경 (먹을텐데) | @sikifoods | 400만+ |
| 🍽️ 맛집 | 백종원 | @paboriver | 600만+ |
| 🍽️ 맛집 | 최자로드 | @choizaroad | 100만+ |
| 🍷 미식 | 비밀이야 | @secretfood | 50만+ |
| 🍷 미식 | 와인 마시는 아톰 | @wineatom | 30만+ |
| ✈️ 여행 | 빠니보틀 | @panibottle | 400만+ |
| ✈️ 여행 | 곽튜브 | @kwaktube | 300만+ |
| ✈️ 여행 | 원지의하루 | @wonjisday | 150만+ |
| 🌍 현지 | 파리외노자 | @parisonenoza | 20만+ |
| 🌍 현지 | CHUNG Haemi | @chunghaemi | 10만+ |
| 🌍 현지 | 마키친 | @makitchen | 15만+ |

#### 관리자 API 엔드포인트

| Method | Endpoint | 설명 |
|--------|----------|------|
| GET | `/api/admin/channels` | 채널 목록 조회 |
| POST | `/api/admin/channels` | 채널 추가 |
| PUT | `/api/admin/channels/:id` | 채널 수정 |
| DELETE | `/api/admin/channels/:id` | 채널 삭제 |
| GET | `/api/admin/sources` | 블로그/리뷰 소스 목록 |
| POST | `/api/admin/sources` | 소스 추가 |
| PUT | `/api/admin/sources/:id` | 소스 수정 |
| DELETE | `/api/admin/sources/:id` | 소스 삭제 |
| GET | `/api/admin/collection/status` | 수집 현황 조회 |
| POST | `/api/admin/collection/run` | 수동 수집 실행 |
| PUT | `/api/admin/collection/settings` | 수집 설정 변경 |

#### 접근 방식
- **옵션 A**: 프로필 화면 내 "관리자" 섹션 (간단)
- **옵션 B**: 별도 관리자 화면 (탭 또는 모달)
- **옵션 C**: 웹 대시보드 (Express 서버에서 제공)

**권장: 옵션 A** - 프로필 화면에 "데이터 소스 관리" 버튼 추가

---

### 🔑 필요한 API 키

| API | 환경변수명 | 무료 한도 | 비용 |
|-----|-----------|----------|------|
| Google Places | `Google_maps_api_key` | $200/월 크레딧 | 유료 |
| YouTube Data | `YOUTUBE_DATA_API_KEY` | 10,000 쿼터/일 | 무료 |
| OpenWeather | `OPENWEATHER_API_KEY` | 1,000 콜/일 | 무료 |
| Exchange Rate | `EXCHANGE_RATE_API_KEY` | 1,500 콜/월 | 무료 |

**Gemini AI**: 이미 연동됨 (`AI_INTEGRATIONS_GEMINI_API_KEY`)

---

### ✅ 구현 순서

| 단계 | 태스크 | 예상 시간 | 의존성 |
|------|--------|----------|--------|
| 1 | DB 스키마 추가 (채널, 외부데이터, 위기정보) | 30분 | 없음 |
| 2 | YouTube 채널 화이트리스트 관리 서비스 | 1시간 | Step 1 |
| 3 | 프로필 화면에 '신뢰 채널 관리' UI | 1시간 | Step 2 |
| 4 | Gemini Web Search 다중 소스 수집 서비스 | 2시간 | Step 1 |
| 5 | YouTube Data API 연동 (자막+타임스탬프) | 2시간 | YouTube API 키 |
| 6 | 가격 정보 수집 + 일별 합계 계산 | 1시간 | Step 4 |
| 7 | 위기 정보 수집 서비스 | 1시간 | Step 4 |
| 8 | 새벽 3시 Cron Job 설정 | 30분 | Step 4-7 |
| 9 | 수집 타임스탬프 UI 표시 | 30분 | Step 8 |
| 10 | [유튜버 Pick] 배지 + 임베드 플레이어 UI | 1시간 | Step 5 |
| 11 | 일별 예산 합계 UI | 30분 | Step 6 |

**총 예상 시간: 약 11시간**

---

### 🏆 경쟁사 Gap 분석 및 차별화

#### 현재 경쟁 서비스 분석

| 서비스 | 장점 | 한계점 |
|--------|------|--------|
| **Google Maps** | 방대한 데이터, 정확한 위치 | 감성 분석 없음, 일정 생성 수동 |
| **TripAdvisor** | 사용자 리뷰 풍부 | 한국어 리뷰 부족, 감성 기반 X |
| **마이리얼트립** | 한국어, 가이드 연결 | 자유여행 일정 생성 약함 |
| **네이버 블로그** | 한국어 후기 많음 | 검색 필요, 자동 분석 X |
| **여행에 미치다** | 유튜브 기반, 한국어 | 텍스트 기반, 앱 없음 |

#### VibeTrip 3대 차별화 포인트

```
┌─────────────────────────────────────────────────────────────┐
│                    🎯 VibeTrip 차별화                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1️⃣  다중 소스 데이터 융합                                   │
│  ┌─────────────────────────────────────────────────────────┐│
│  │  경쟁사: 단일 소스 (Google OR TripAdvisor OR 블로그)      ││
│  │  VibeTrip: 9개 소스 동시 분석 + AI 통합 점수 (Vibe Score) ││
│  │  → 유튜버 + 미슐랭 + 블로그 + 리뷰 = 신뢰도 극대화        ││
│  └─────────────────────────────────────────────────────────┘│
│                                                             │
│  2️⃣  데이터 신선도 투명성                                    │
│  ┌─────────────────────────────────────────────────────────┐│
│  │  경쟁사: 데이터 수집 시점 불명확                          ││
│  │  VibeTrip: "수집: 2026.01.05 03:00" 명시                 ││
│  │  → 30일 이상 경과 시 경고, 사용자가 신선도 직접 확인       ││
│  └─────────────────────────────────────────────────────────┘│
│                                                             │
│  3️⃣  신뢰 채널 화이트리스트                                  │
│  ┌─────────────────────────────────────────────────────────┐│
│  │  경쟁사: 불특정 리뷰 (신뢰도 불확실)                      ││
│  │  VibeTrip: 검증된 인플루언서만 (성시경, 백종원, 빠니보틀)  ││
│  │  → 사용자도 신뢰 채널 추가 가능, 개인화된 추천             ││
│  └─────────────────────────────────────────────────────────┘│
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 차별화 요약 표
| 기능 | Google | TripAdvisor | 마이리얼트립 | **VibeTrip** |
|------|--------|-------------|-------------|--------------|
| 다중 소스 융합 | ❌ | ❌ | ❌ | ✅ 9개 소스 |
| 감성 기반 추천 | ❌ | ❌ | △ | ✅ Vibe Score |
| 수집 시점 표시 | ❌ | ❌ | ❌ | ✅ 실시간 |
| 유튜버 Pick | ❌ | ❌ | ❌ | ✅ 타임스탬프 연동 |
| 신선도 경고 | ❌ | ❌ | ❌ | ✅ 30일 경과 알림 |
| 한국어 우선 | ❌ | ❌ | ✅ | ✅ |
| AI 일정 생성 | △ | ❌ | △ | ✅ |

---

### 📝 블로그/리뷰 소스 관리

#### 추가 DB 스키마 (블로그 소스)

```sql
-- 블로그/리뷰 소스 화이트리스트 테이블
CREATE TABLE blog_sources (
  id SERIAL PRIMARY KEY,
  source_name VARCHAR(200) NOT NULL,
  source_type VARCHAR(50) NOT NULL, -- 'michelin', 'tripadvisor', 'blog', 'sns'
  source_url VARCHAR(500),
  region_scope VARCHAR(100), -- 'global', 'korea', 'europe', 'asia' 등
  language VARCHAR(10) DEFAULT 'ko', -- 'ko', 'en', 'ja' 등
  trust_weight DECIMAL(3,2) DEFAULT 1.0, -- 0.00 ~ 1.00 가중치
  is_active BOOLEAN DEFAULT TRUE,
  added_by VARCHAR(50) DEFAULT 'system',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- 기본 블로그 소스 시드 데이터
INSERT INTO blog_sources (source_name, source_type, source_url, region_scope, language, trust_weight) VALUES
('Michelin Guide', 'michelin', 'https://guide.michelin.com', 'global', 'en', 1.0),
('TripAdvisor', 'tripadvisor', 'https://tripadvisor.com', 'global', 'en', 0.9),
('네이버 블로그', 'blog', 'https://blog.naver.com', 'korea', 'ko', 0.8),
('티스토리', 'blog', 'https://tistory.com', 'korea', 'ko', 0.7),
('Instagram', 'sns', 'https://instagram.com', 'global', 'en', 0.6),
('Yelp', 'review', 'https://yelp.com', 'global', 'en', 0.85),
('OpenTable', 'booking', 'https://opentable.com', 'global', 'en', 0.9),
('The Infatuation', 'review', 'https://theinfatuation.com', 'global', 'en', 0.85);
```

#### 블로그 수집 파이프라인

```
[블로그 소스 DB]
    │
    ├── 미슐랭: guide.michelin.com/ko/restaurants
    ├── TripAdvisor: tripadvisor.com/Restaurants
    ├── 네이버: blog.naver.com (검색 API)
    └── 티스토리: tistory.com (검색)
    │
    ▼
[Gemini Web Search + grounding]
    │
    ├── Query: "{장소명} {소스} 리뷰 평가"
    ├── 언어별 검색 (한국어/영어/현지어)
    └── 최신순 정렬
    │
    ▼
[데이터 추출 및 정규화]
    │
    ├── rating: 평점 추출 (5점 만점 → 10점 변환)
    ├── review_count: 리뷰 개수
    ├── sentiment: 긍정/부정/중립 분류
    ├── summary: 핵심 내용 3줄 요약
    └── source_url: 원본 링크
    │
    ▼
[DB 저장] → place_external_data
```

---

### ⚠️ 데이터 신선도 경고 시스템

#### 신선도 레벨 정의

| 경과 일수 | 레벨 | 아이콘 | 표시 |
|----------|------|--------|------|
| 0-7일 | 🟢 Fresh | ✅ | "방금 수집" |
| 8-14일 | 🟡 Recent | 🕐 | "1주 전 수집" |
| 15-30일 | 🟠 Aging | ⚠️ | "2주 전 수집" |
| 31일+ | 🔴 Stale | 🚨 | "오래된 데이터" |

#### 신선도 UI 표시

```
┌────────────────────────────────────────────────────────┐
│ 🍜 광장시장 육회골목                                     │
│ ────────────────────────────────────────────────────── │
│ ⭐ Vibe 8.5  │  📺 유튜버 Pick  │  🌟 빕구르망           │
│ ────────────────────────────────────────────────────── │
│ 💰 예상: ₩15,000~25,000                                │
│ ────────────────────────────────────────────────────── │
│ ✅ 수집: 2026.01.05 03:15 (오늘)                        │
└────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────┐
│ 🍕 Pizzeria Da Michele (나폴리)                          │
│ ────────────────────────────────────────────────────── │
│ ⭐ Vibe 9.2  │  🌟 미슐랭 1스타                          │
│ ────────────────────────────────────────────────────── │
│ 💰 예상: €12~18                                         │
│ ────────────────────────────────────────────────────── │
│ ⚠️ 수집: 2025.12.10 03:15 (26일 전)                     │
│    [🔄 최신 데이터 요청]                                │
└────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────┐
│ 🍣 스시 사이토 (도쿄)                                    │
│ ────────────────────────────────────────────────────── │
│ ⭐ Vibe 9.8  │  🌟 미슐랭 3스타                          │
│ ────────────────────────────────────────────────────── │
│ 💰 예상: ¥30,000~50,000                                 │
│ ────────────────────────────────────────────────────── │
│ 🚨 수집: 2025.11.15 03:15 (51일 전) - 오래된 데이터     │
│    [🔄 최신 데이터 요청]  [ℹ️ 왜 오래됐나요?]            │
└────────────────────────────────────────────────────────┘
```

#### 신선도 계산 로직

```typescript
// server/services/data-freshness.ts
export function getDataFreshness(collectedAt: Date): {
  level: 'fresh' | 'recent' | 'aging' | 'stale';
  daysAgo: number;
  displayText: string;
  icon: string;
  warningLevel: 0 | 1 | 2 | 3;
} {
  const now = new Date();
  const diffMs = now.getTime() - collectedAt.getTime();
  const daysAgo = Math.floor(diffMs / (1000 * 60 * 60 * 24));

  if (daysAgo <= 7) {
    return {
      level: 'fresh',
      daysAgo,
      displayText: daysAgo === 0 ? '오늘 수집' : `${daysAgo}일 전 수집`,
      icon: '✅',
      warningLevel: 0
    };
  } else if (daysAgo <= 14) {
    return {
      level: 'recent',
      daysAgo,
      displayText: '1주 전 수집',
      icon: '🕐',
      warningLevel: 1
    };
  } else if (daysAgo <= 30) {
    return {
      level: 'aging',
      daysAgo,
      displayText: `${Math.floor(daysAgo / 7)}주 전 수집`,
      icon: '⚠️',
      warningLevel: 2
    };
  } else {
    return {
      level: 'stale',
      daysAgo,
      displayText: '오래된 데이터',
      icon: '🚨',
      warningLevel: 3
    };
  }
}
```

#### 사용자 액션

| 상태 | 사용자 옵션 |
|------|------------|
| 🟢 Fresh | 없음 (정상) |
| 🟡 Recent | "최신 데이터 요청" 버튼 (숨김) |
| 🟠 Aging | "최신 데이터 요청" 버튼 (표시) |
| 🔴 Stale | "최신 데이터 요청" + 경고 배너 |

**"최신 데이터 요청"** 클릭 시:
1. 해당 장소만 즉시 재수집 (Gemini Web Search)
2. 수집 완료 후 UI 자동 업데이트
3. 수집 로그에 "사용자 요청" 기록

---

## Phase 2: 핵심 AI 기능

### 2.1 AI 추천 엔진

| 태스크 | 상태 | 설명 |
|--------|------|------|
| Gemini Vision 연동 | ✅ | Vibe Score 분석 |
| Taste Verification | ⬜ | 언어 기반 리뷰 분석 |
| 페르소나별 가중치 | ⬜ | 럭셔리/컴포트 차별화 |

### 2.2 동선 최적화

| 태스크 | 상태 | 설명 |
|--------|------|------|
| Google Routes API | ⬜ | 실시간 이동 시간 |
| Time vs Money 옵션 | ⬜ | 대중교통/택시 비교 |
| 지도 오버레이 | ⬜ | 최적 경로 시각화 |

---

## Phase 3: 고급 기능 (향후)

### 3.1 미디어 기능 - AI Travel Casting

> **핵심 컨셉**: "로우 데이터는 배경(Stage), AI는 연출자(Director), 사용자 입력 정보가 배우(Actor)"

#### 🎬 역할 분담 아키텍처

| 역할 | 담당 | 데이터 소스 |
|------|------|------------|
| **Stage (배경)** | 실제 여행지 사진/영상 | Google Places (10장), Instagram (자동 수집) |
| **Director (연출)** | AI가 사용자 VIBE 선호도에 따라 장면 구성 | Gemini + Veo 3.1 |
| **Actor (배우)** | 사용자 프로필 기반 가상 페르소나 | 연령, 구성원, 여행 스타일 입력값 |

---

#### 📋 태스크 목록

| 태스크 | 상태 | 설명 |
|--------|------|------|
| 숏폼 미리보기 | ⬜ | 일정 기반 15-30초 영상 |
| 실제 사진/영상 매핑 | ⬜ | 저작권 안전한 콘텐츠 |
| AI 페르소나 생성 | ⬜ | 사용자 프로필 → 가상 모델 캐스팅 |
| Veo 3.1 연동 | ⬜ | 배경 + 페르소나 합성 영상 생성 |
| 캐릭터 일관성 유지 | ⬜ | Seed 고정/Character Reference로 동일 인물 유지 |

---

#### 👥 페르소나 자동 생성 로직 (Input → AI Prompt)

**사용자 입력 예시:**
```
연령: 30대
구성원: 커플  
국적: 한국인
스타일: 럭셔리 여행
```

**AI 내부 변환 (Persona Prompt):**
```
"A stylish Korean couple in their early 30s, 
fashionable travel attire, happy and relaxed expression, 
high-end luxury vibe."
```

**지원 구성:**
| 구성 | 생성되는 페르소나 |
|------|-----------------|
| 혼자 | 세련된 솔로 트래블러 (남/여) |
| 커플 | 로맨틱한 한국인 커플 |
| 가족 | 부모 + 자녀 (연령대 반영) |
| 친구 | 같은 성별 2-4인 그룹 |

---

#### 🎞️ 시나리오별 영상 생성 예시 (파리 3일, 30대 커플)

| Scene | 배경 (Stage) | 연출 (Director) | 배우 (Actor) |
|-------|-------------|----------------|--------------|
| Intro | 공항 라운지 | 럭셔리 분위기 연출 | AI 생성 한국인 커플 |
| Scene 1 | 에펠탑 (Google Photos) | 로맨틱 와인 건배 | 동일 커플 유지 |
| Scene 2 | 르 트랑 블루 (Instagram) | 미슐랭 디너 | 동일 커플 유지 |
| Scene 3 | 마레지구 (Google Photos) | 쇼핑 뒷모습 | 동일 커플 유지 |
| Outro | 센강 야경 | 여행 마무리 | 동일 커플 유지 |

---

#### 🛠️ 기술적 이점

1. **Zero Friction**: 사진 업로드 부담 제거 → 이탈률 0%
2. **Uncanny Valley 해결**: 어설픈 얼굴 합성 대신 처음부터 자연스러운 AI 생성 인물
3. **다양한 구성 대응**: 어떤 여행 구성이든 AI가 최적의 모델 자동 캐스팅
4. **캐릭터 일관성**: Veo 3.1 Seed 고정으로 여행 전체에서 동일 인물 유지

---

#### 📱 UI/UX 구현 (미리보기 탭)

```
┌─────────────────────────────────────────────────────┐
│  🎬 여행 미리보기                                    │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ◉ AI 모델 캐스팅 (추천)                            │
│    "여행 분위기에 딱 맞는 AI 모델이 대신 여행합니다"   │
│                                                     │
│    스타일 선택:                                      │
│    [힙한 ✓]  [차분한]  [럭셔리]                      │
│                                                     │
│  ○ 내 사진 합성 (고급)                              │
│    "주인공이 직접 되고 싶으신가요?"                   │
│    [사진 업로드]                                     │
│                                                     │
├─────────────────────────────────────────────────────┤
│  [▶️ 미리보기 생성]                                  │
└─────────────────────────────────────────────────────┘
```

---

#### 🗃️ 데이터 활용 매핑

| 수집 데이터 | 활용처 |
|------------|--------|
| `places.photoUrls` (Google 10장) | Veo 3.1 배경 레퍼런스 |
| `places.instagramPhotoUrls` | 트렌디한 앵글/구도 참고 |
| `places.instagramHashtags` | 인기 스팟 우선 노출 |
| 사용자 프로필 (연령/구성/스타일) | 페르소나 생성 프롬프트 |
| 여행 일정 (itinerary) | 장면 시퀀스 구성 |

---

### 3.2 예약 자동화

| 태스크 | 상태 | 설명 |
|--------|------|------|
| 결제 시스템 | ⬜ | Stripe 연동 |
| OTA API 연동 | ⬜ | 항공/호텔 예약 |

---

## 우선순위 (협의 필요)

### 🔴 긴급 (이번 세션)
1. 사용자 입력 시스템 설계 및 구현
2. Vibe Score UI 표시
3. 성능 최적화

### 🟡 중요 (다음 단계)
4. API 키 연동
5. Taste Verification 구현
6. 동선 최적화

### 🟢 향후
7. 숏폼 미리보기
8. 예약 자동화

---

## 현재 이슈

| 이슈 | 상태 | 해결방안 |
|------|------|----------|
| 앱 정체성 불명확 | 🔴 | Vibe 입력 + 점수 표시로 차별화 |
| 버튼 반응 느림 | 🔴 | memo, useMemo 적용 |
| API 키 미설정 | 🟡 | 사용자에게 요청 필요 |
| 샘플 데이터만 표시 | 🟡 | API 연동 후 해결 |
