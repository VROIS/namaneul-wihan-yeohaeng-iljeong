# 🎬 Phase E - 감동 영상 아키텍처 설계

> **작성일: 2026-01-25** | **버전: 1.0**

---

## 🎯 핵심 개념

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│   🎬 NUBI 감동 영상 = 일정표(itinerary) 기반 자동 생성                       │
│                                                                              │
│   ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                  │
│   │  📊 일정표    │ →  │  🎭 캐릭터    │ →  │  🎥 영상     │                  │
│   │  (8개 입력)   │    │  (14명 매칭)  │    │  (1분/일)    │                  │
│   └──────────────┘    └──────────────┘    └──────────────┘                  │
│                                                                              │
│   💡 핵심 원칙: 일정표 = 영상의 뼈대                                         │
│   💡 travelPace가 클립 수, 템포, 길이를 결정                                 │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 📱 사용자 입력 정보 (9개)

### 로그인 정보 (users 테이블)
| 필드 | 설명 | 영상 활용 |
|------|------|----------|
| birthDate | 생년월일 | 본인 연령대 → 캐릭터 매칭 |

### 8개 입력 정보 (itineraries 테이블)
| 필드 | 설명 | 영상 활용 |
|------|------|----------|
| destination | 목적지 | 배경 장소 |
| startDate/endDate | 여행 기간 | 일별 영상 수 |
| curationFocus | 누구를 위한 | **주인공** 결정 ⭐ |
| companionType | 동행 유형 | 캐릭터 구성 |
| companionCount | 인원 수 | 캐릭터 수 |
| companionAges | 동행 나이 | 캐릭터 연령대 |
| vibes | 여행 분위기 | 연출 톤/대사 |
| travelPace | 여행 밀도 | **클립 수/템포** ⭐ |

---

## 🔄 전체 파이프라인

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ ① 프론트엔드 (Expo App)                                                      │
│    사용자 입력 9개 수집 → API 호출                                            │
└───────────────────────────┬─────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ ② 백엔드 API (Express)                                                       │
│                                                                              │
│    ┌─────────────────────────────────────────────────────────────────────┐  │
│    │ [병렬 처리 - Step A]                                                 │  │
│    │  A1. itinerary-generator → 일정표 생성                              │  │
│    │  A2. 캐릭터 매칭 (birthDate + companionAges → 캐릭터 ID)             │  │
│    │  A3. 배경 이미지 준비 (places.photoUrls)                            │  │
│    └─────────────────────────────────────────────────────────────────────┘  │
│                            ↓                                                │
│    ┌─────────────────────────────────────────────────────────────────────┐  │
│    │ [병렬 처리 - Step B] 일별 영상 생성                                  │  │
│    │  B1. Day 1 영상 (N장소) ─┬─→ mp4                                    │  │
│    │  B2. Day 2 영상 (N장소) ─┼─→ mp4   (동시 렌더링)                    │  │
│    │  B3. Day 3 영상 (N장소) ─┘─→ mp4                                    │  │
│    └─────────────────────────────────────────────────────────────────────┘  │
│                            ↓                                                │
│    ┌─────────────────────────────────────────────────────────────────────┐  │
│    │ [Step C] 전체 영상 병합                                              │  │
│    │  Day 1 + Day 2 + Day 3 = 전체 영상                                  │  │
│    └─────────────────────────────────────────────────────────────────────┘  │
└───────────────────────────┬─────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ ③ DB 저장 (itineraries 테이블 확장)                                          │
│    videoUrlDay1, videoUrlDay2, videoUrlDay3, videoUrlFull, videoStatus       │
└───────────────────────────┬─────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ ④ 프론트엔드 (React Native / Expo)                                           │
│    - 일별 영상 보기 (Day 1, Day 2, Day 3)                                    │
│    - 전체 영상 보기                                                          │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 🎭 캐릭터 매칭 로직

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         🎭 캐릭터 매칭 알고리즘                              │
│                                                                              │
│  입력:                                                                       │
│  • birthDate (사용자 생년월일) → 본인 캐릭터                                 │
│  • companionAges (동행 나이들) → 동행 캐릭터들                               │
│  • curationFocus (누구를 위한) → 주인공 결정                                 │
│                                                                              │
│  연령대 → 캐릭터 ID 매핑:                                                    │
│  ┌────────────┬──────────┬──────────┐                                       │
│  │ 연령대     │ 남성     │ 여성     │                                       │
│  ├────────────┼──────────┼──────────┤                                       │
│  │ 10세 미만  │ M1       │ F1       │                                       │
│  │ 10대       │ M2       │ F2       │                                       │
│  │ 20대       │ M3       │ F3       │                                       │
│  │ 30대       │ M4       │ F4       │                                       │
│  │ 40대       │ M5       │ F5       │                                       │
│  │ 50대       │ M6       │ F6       │                                       │
│  │ 60대 이상  │ M7       │ F7       │                                       │
│  └────────────┴──────────┴──────────┘                                       │
│                                                                              │
│  주인공 결정 (curationFocus):                                                │
│  • Kids → 가장 어린 아이 캐릭터가 주인공                                     │
│  • Parents → 가장 나이 많은 캐릭터가 주인공                                  │
│  • Everyone → 본인이 주인공                                                  │
│  • Self → 본인이 주인공                                                      │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 📊 클립 수 결정 (travelPace 기반)

| travelPace | 슬롯 간격 | 하루 장소 수 | 클립 수 | 클립당 시간 | 일별 영상 |
|------------|----------|-------------|--------|------------|----------|
| **Packed** (빡빡하게) | 90분 | 8곳 | 8 | ~7.5초 | 1분 |
| **Normal** (보통) | 120분 | 6곳 | 6 | ~10초 | 1분 |
| **Relaxed** (여유롭게) | 150분 | 4곳 | 4 | ~15초 | 1분 |

---

## 💾 DB 확장 (itineraries 테이블)

```sql
ALTER TABLE itineraries ADD COLUMN video_url_day1 TEXT;
ALTER TABLE itineraries ADD COLUMN video_url_day2 TEXT;
ALTER TABLE itineraries ADD COLUMN video_url_day3 TEXT;
ALTER TABLE itineraries ADD COLUMN video_url_full TEXT;
ALTER TABLE itineraries ADD COLUMN video_status TEXT DEFAULT 'pending';
-- pending, generating, completed, failed
```

---

## 🔌 API 엔드포인트

| 엔드포인트 | 메서드 | 설명 |
|-----------|--------|------|
| `/api/video/generate/:itineraryId` | POST | 영상 생성 시작 (관리자용) |
| `/api/video/status/:itineraryId` | GET | 생성 상태 조회 |
| `/api/video/:itineraryId/day/:dayNum` | GET | 일별 영상 URL |
| `/api/video/:itineraryId/full` | GET | 전체 영상 URL |

---

## 🎬 일별 영상 생성 흐름

```
[입력]
  - itineraryItems (day=1, N장소)
  - 캐릭터 ID (M4, F5, M7 등)
  - curationFocus (주인공)
  - vibes (분위기)
        ↓
[Gemini] 대사 자동 생성
  - 장소별 주인공 대사
  - 동반자 반응
        ↓
[Seedance 1.5 Pro] 클립 생성 (병렬 N개)
  - 캐릭터 + 배경 + 음성
        ↓
[Remotion] 합성/렌더링
  - N클립 → 1분 영상
        ↓
[S3/R2] 저장 → URL 반환
```

---

## 💰 예상 비용

| 구성 요소 | 비용 | 비고 |
|----------|------|------|
| Seedance 1.5 Pro | ~$0.14/8초 클립 | 음성+립싱크 통합 |
| Remotion Lambda | ~$0.02/분 | 렌더링 비용 |
| Gemini | ~무료 | 대사 생성 |
| **총 (1분 영상)** | **~$1.20-1.50** | 8클립 기준 |

---

## 🤖 AI 역할 분담 (최적화 버전)

> **TTS 별도 사용 안함** - Seedance 1.5 Pro가 음성+립싱크+애니메이션 통합 생성

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         🤖 AI 역할 분담                                     │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  🧠 Gemini 3.0 (대사 + 프롬프트 생성)                                   │ │
│  │                                                                         │ │
│  │  입력:                                                                  │ │
│  │  • itinerary 데이터 (장소, 시간, 유형)                                  │ │
│  │  • curationFocus (주인공)                                               │ │
│  │  • vibes (분위기)                                                       │ │
│  │  • companionType (동행 구성)                                            │ │
│  │                                                                         │ │
│  │  출력:                                                                  │ │
│  │  • 장소별 주인공 대사 (한국어)                                          │ │
│  │  • 동반자 반응/대사                                                     │ │
│  │  • Seedance용 영상 프롬프트 (영어, 최적화)                              │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                            ↓                                                │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  🎬 Seedance 1.5 Pro (통합 클립 생성 - TTS 불필요!)                     │ │
│  │                                                                         │ │
│  │  입력:                                                                  │ │
│  │  • 캐릭터 이미지 (지블리 스타일)                                        │ │
│  │  • 배경 이미지 (장소 photoUrl)                                          │ │
│  │  • 대사 텍스트 (한국어)                                                 │ │
│  │  • 영상 프롬프트 (Gemini 생성)                                          │ │
│  │                                                                         │ │
│  │  출력 (통합 생성):                                                      │ │
│  │  • ✅ 음성 (TTS 통합)                                                  │ │
│  │  • ✅ 립싱크                                                           │ │
│  │  • ✅ 캐릭터 애니메이션                                                │ │
│  │  • ✅ 배경 합성                                                        │ │
│  │  → 8초 클립 mp4                                                        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                            ↓                                                │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  🎥 Remotion (최종 합성)                                                │ │
│  │                                                                         │ │
│  │  • N개 클립 시퀀스 조합                                                 │ │
│  │  • 전환 효과 (페이드/슬라이드)                                          │ │
│  │  • 장소 정보 오버레이                                                   │ │
│  │  → 1분 영상 mp4                                                        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Gemini 대사 생성 프롬프트 예시

```json
// [입력]
{
  "장소": "에펠탑",
  "주인공": "5살 아이 (curationFocus: Kids)",
  "동행": ["30대 아빠", "60대 할아버지"],
  "분위기": ["힐링", "가족"]
}

// [출력]
{
  "주인공_대사": "와! 저기 봐요! 에펠탑이에요!",
  "동반자_반응": [
    { "캐릭터": "M4", "대사": "그래, 정말 멋지지?" },
    { "캐릭터": "M7", "대사": "할아버지도 처음 왔을 때 이랬단다" }
  ],
  "영상_프롬프트": "A cute Korean child pointing excitedly at Eiffel Tower, family watching warmly, soft sunlight, Studio Ghibli style"
}
```

---

## 📁 관련 파일

| 파일 | 설명 |
|------|------|
| `server/services/scene-prompt-generator.ts` | 🆕 장면별 프롬프트 자동 생성 |
| `server/services/seedance-video-generator.ts` | Seedance API 연동 |
| `server/routes.ts` | 영상 관련 API 엔드포인트 |
| `docs/PHASE_E_VIDEO_MAPPING.md` | 🆕 입력 → 영상 매핑 표준 |
| `docs/PHASE_E_TASK.md` | 작업 목록 |
| `docs/PHASE_E_WORKLOG.md` | 작업 로그 |