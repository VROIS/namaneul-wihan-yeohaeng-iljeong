# NUBI AI 규칙

## 필수 준수사항

1. **핵심 문서 (절대 삭제 금지)**
   - docs/TASK.md - 작업 현황
   - docs/PRD.md - 제품 요구사항
   - docs/TRD.md - 기술 요구사항
   - docs/NUBI_WHITEPAPER.md - 핵심 알고리즘 백서

2. **새 .md 파일 생성 금지**
   - 임의로 새 문서 파일 생성하지 말 것
   - 필요한 정보는 기존 문서에 추가

3. **핵심 파일 보호 (명시적 요청 없이 수정 금지)**
   - server/services/itinerary-generator.ts (스코어링 엔진, 가중치, 비용 계산)
   - client/utils/vibeCalculator.ts (Vibe 가중치 계산)
   - shared/schema.ts (DB 스키마 - 변경시 데이터 손실)
   - server/db.ts (DB 연결 설정)
   - server/index.ts (서버 진입점)

4. **코드 수정 전 반드시 사용자에게 확인 요청**
   - 추측하지 말고 모르면 질문할 것
   - 기존 코드 스타일/패턴 유지

## 프로젝트 상태

- **완성도**: 80%
- **백엔드 구조**: 확정 (변경 금지)
- **핵심 로직**: 검증 완료 (500유로 투자)
- **검증 비용**: 1개월 500유로 투자하여 확인/검증 완료

## 핵심 원칙

- 원본 코드 보존 우선
- 추측/추정 수정 금지
- 명시적 요청 없이 핵심 로직 수정 금지

---

# 🚨 로우데이터 수집 필수 지침 (절대 준수)

> **모든 API/크롤러를 통한 데이터 수집 시 아래 원칙을 반드시 따를 것**

## 1. DB 테이블/필드 확인 (한국어 깨짐 방지)

```
┌─────────────────────────────────────────────────────────────────────────┐
│  ✅ 필수 체크리스트                                                      │
│                                                                         │
│  □ DB 연결 시 UTF-8 인코딩 강제 (server/db.ts)                          │
│  □ 저장 전 hasBrokenEncoding() 함수로 검증                              │
│  □ 깨진 데이터 감지 시 저장 거부 + 로그 기록                            │
│  □ 한글 필드는 반드시 정상 한글로 저장 확인                             │
│                                                                         │
│  ❌ 절대 금지                                                           │
│  - 인코딩 검증 없이 데이터 저장                                         │
│  - 깨진 데이터를 사용자 화면에 노출                                     │
└─────────────────────────────────────────────────────────────────────────┘
```

**적용 위치**: 
- `server/db.ts` - `options: "-c client_encoding=UTF8"`
- 모든 크롤러 - `hasBrokenEncoding()` 검증 후 저장

## 2. 대시보드 실시간 연동 (목업 금지)

```
┌─────────────────────────────────────────────────────────────────────────┐
│  🎯 관리자 대시보드 = 실시간 관제탑                                      │
│                                                                         │
│  ✅ 모든 버튼/기능은 실제 DB와 연동되어야 함                            │
│  ✅ 수집 버튼 → 실제 API 호출 → DB 저장 → 화면 반영                     │
│  ✅ 통계/현황은 실시간 DB 쿼리 결과                                     │
│                                                                         │
│  ❌ 절대 금지                                                           │
│  - 하드코딩된 더미 데이터                                               │
│  - 연결되지 않는 UI 요소                                                │
│  - 작동하지 않는 버튼                                                   │
└─────────────────────────────────────────────────────────────────────────┘
```

**검증 방법**: 
- 버튼 클릭 → 서버 로그 확인 → DB 변경 확인 → 화면 반영 확인

## 3. UI 추가 최소화 원칙

```
┌─────────────────────────────────────────────────────────────────────────┐
│  🎨 UI 변경 원칙                                                        │
│                                                                         │
│  ✅ 기존 UI 요소 최대 활용                                              │
│  ✅ 새 버튼/기능은 검증 완료 후에만 추가                                │
│  ✅ 불필요한 UI 요소 생성 금지                                          │
│                                                                         │
│  📋 체크리스트                                                          │
│  □ 기존에 비슷한 기능이 있는지 확인                                     │
│  □ 새 기능이 정말 필요한지 검토                                         │
│  □ 추가 전 작동 검증 완료                                               │
│  □ 기존 UI 레이아웃 해치지 않는지 확인                                  │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 데이터 무결성 유틸리티

```typescript
// server/utils/db-encoding.ts 사용
import { hasBrokenEncoding, sanitizeForDB } from './utils/db-encoding';

// 저장 전 검증 예시
if (hasBrokenEncoding(data.title)) {
  console.warn('[Crawler] 깨진 데이터 감지, 저장 거부:', data.title);
  return; // 저장하지 않음
}

const cleanData = sanitizeForDB(data);
await db.insert(table).values(cleanData);
```
