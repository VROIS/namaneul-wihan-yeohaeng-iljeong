# NUBI AI 규칙

## 필수 준수사항

1. **핵심 문서 (절대 삭제 금지)**
   - docs/TASK.md - 작업 현황
   - docs/PRD.md - 제품 요구사항
   - docs/TRD.md - 기술 요구사항
   - docs/NUBI_WHITEPAPER.md - 핵심 알고리즘 백서

2. **새 .md 파일 생성 금지**
   - 임의로 새 문서 파일 생성하지 말 것
   - 필요한 정보는 기존 문서에 추가

3. **핵심 파일 보호 (명시적 요청 없이 수정 금지)**
   - server/services/itinerary-generator.ts (스코어링 엔진, 가중치, 비용 계산)
   - client/utils/vibeCalculator.ts (Vibe 가중치 계산)
   - shared/schema.ts (DB 스키마 - 변경시 데이터 손실)
   - server/db.ts (DB 연결 설정)
   - server/index.ts (서버 진입점)

4. **코드 수정 전 반드시 사용자에게 확인 요청**
   - 추측하지 말고 모르면 질문할 것
   - 기존 코드 스타일/패턴 유지

## 프로젝트 상태

- **완성도**: 80%
- **백엔드 구조**: 확정 (변경 금지)
- **핵심 로직**: 검증 완료 (500유로 투자)
- **검증 비용**: 1개월 500유로 투자하여 확인/검증 완료

## 핵심 원칙

- 원본 코드 보존 우선
- 추측/추정 수정 금지
- 명시적 요청 없이 핵심 로직 수정 금지

---

# 🚨 로우데이터 수집 필수 지침 (절대 준수)

> **모든 API/크롤러를 통한 데이터 수집 시 아래 원칙을 반드시 따를 것**

## 1. DB 테이블/필드 확인 (한국어 깨짐 방지)

```
┌─────────────────────────────────────────────────────────────────────────┐
│  ✅ 필수 체크리스트                                                      │
│                                                                         │
│  □ DB 연결 시 UTF-8 인코딩 강제 (server/db.ts)                          │
│  □ 저장 전 hasBrokenEncoding() 함수로 검증                              │
│  □ 깨진 데이터 감지 시 저장 거부 + 로그 기록                            │
│  □ 한글 필드는 반드시 정상 한글로 저장 확인                             │
│                                                                         │
│  ❌ 절대 금지                                                           │
│  - 인코딩 검증 없이 데이터 저장                                         │
│  - 깨진 데이터를 사용자 화면에 노출                                     │
└─────────────────────────────────────────────────────────────────────────┘
```

**적용 위치**: 
- `server/db.ts` - `options: "-c client_encoding=UTF8"`
- 모든 크롤러 - `hasBrokenEncoding()` 검증 후 저장

## 2. 대시보드 실시간 연동 (목업 금지)

```
┌─────────────────────────────────────────────────────────────────────────┐
│  🎯 관리자 대시보드 = 실시간 관제탑                                      │
│                                                                         │
│  ✅ 모든 버튼/기능은 실제 DB와 연동되어야 함                            │
│  ✅ 수집 버튼 → 실제 API 호출 → DB 저장 → 화면 반영                     │
│  ✅ 통계/현황은 실시간 DB 쿼리 결과                                     │
│                                                                         │
│  ❌ 절대 금지                                                           │
│  - 하드코딩된 더미 데이터                                               │
│  - 연결되지 않는 UI 요소                                                │
│  - 작동하지 않는 버튼                                                   │
└─────────────────────────────────────────────────────────────────────────┘
```

**검증 방법**: 
- 버튼 클릭 → 서버 로그 확인 → DB 변경 확인 → 화면 반영 확인

## 3. UI 추가 최소화 원칙

```
┌─────────────────────────────────────────────────────────────────────────┐
│  🎨 UI 변경 원칙                                                        │
│                                                                         │
│  ✅ 기존 UI 요소 최대 활용                                              │
│  ✅ 새 버튼/기능은 검증 완료 후에만 추가                                │
│  ✅ 불필요한 UI 요소 생성 금지                                          │
│                                                                         │
│  📋 체크리스트                                                          │
│  □ 기존에 비슷한 기능이 있는지 확인                                     │
│  □ 새 기능이 정말 필요한지 검토                                         │
│  □ 추가 전 작동 검증 완료                                               │
│  □ 기존 UI 레이아웃 해치지 않는지 확인                                  │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 데이터 무결성 유틸리티

```typescript
// server/utils/db-encoding.ts 사용
import { hasBrokenEncoding, sanitizeForDB } from './utils/db-encoding';

// 저장 전 검증 예시
if (hasBrokenEncoding(data.title)) {
  console.warn('[Crawler] 깨진 데이터 감지, 저장 거부:', data.title);
  return; // 저장하지 않음
}

const cleanData = sanitizeForDB(data);
await db.insert(table).values(cleanData);
```

---

# AI 세션 연속성 프로토콜 (절대 준수)

> **이 프로토콜의 목적: Cursor가 재시작되거나 새 대화가 시작되어도 작업이 끊기지 않도록 보장**

## 1. 세션 시작 시 (필수)

1. 이 `.cursorrules` 파일을 읽는다
2. `docs/TASK.md`의 **"0. 현재 진행 상태 (AI 핸드오프용)"** 섹션을 읽는다
3. 마지막 작업 내용과 다음 해야 할 작업을 파악한다
4. 사용자에게 현재 상태를 간단히 보고하고 작업을 이어간다

## 2. 세션 종료/중단 시 (필수)

- `docs/TASK.md`의 "0. 현재 진행 상태" 섹션을 반드시 업데이트한다
- 마지막 작업 내용, 다음 해야 할 작업, 주의사항을 기록한다
- 진행 중이던 작업의 상태를 정확히 기록한다

## 3. 파일 생성 절대 금지

- 캔버스(Canvas) 임시 파일 생성 금지
- `.plan.md` 파일 생성 금지
- 새로운 `.md` 문서 파일 생성 금지
- 모든 기록은 기존 `docs/TASK.md`에 추가
- 중요 로직/수식 완성 시 반드시 실제 코드 파일에 즉시 반영 (캔버스에만 두면 소멸됨)

## 4. 자율 실행 + 보고 프로토콜

- Agent 모드에서 서브에이전트/스킬을 활용하여 자율 실행
- 각 작업 단계 완료 시 사용자에게 텍스트로 보고 (결과 + 다음 단계)
- 핵심 파일(3번 목록) 수정 시에만 사용자 확인 요청
- 보고 형식: "완료: [작업내용] → 다음: [다음작업]"

## 5. 개발/배포 프로세스 (절대 준수)

- **로컬호스트 사용하지 않음** (localhost 서버 실행 불필요)
- 작업 흐름: **코드 수정 → Git 커밋(cursor-dev 브랜치) → Koyeb 자동 배포 → Supabase DB 반영**
- DB: Supabase PostgreSQL (원격) — 로컬 DB 없음
- 배포 URL: https://legal-dannye-dbstour-4e6b86d5.koyeb.app
- 테스트/검증: 배포된 서버에서 직접 확인
- npm run server:dev 등 로컬 서버 실행 명령 사용 금지

## 6. 한국어 응답

- 모든 응답은 한국어로
- 기술 용어는 비개발자도 이해할 수 있게 쉽게 설명
- NUBI 프로젝트 개발에 집중

## 7. 1차 목표 실행 플랜 (2026-02-07 확정)

> **이 플랜은 사용자가 직접 확정한 앱스토어 배포 목표입니다. 모든 AI 세션은 이 순서를 따릅니다.**

- **실행 순서**: 백엔드 로직 확정 → 프론트엔드 UI 개편 → 수익화 연동
- **상세 플랜**: `docs/TASK.md`의 "1차 목표 실행 플랜" 섹션 참조
- **플랜 파일**: `.cursor/plans/nubi_1차_목표_실행_8b72390e.plan.md`
- **산출물 기준**:
  1. 일정표: 한국인 선호 최우선(인스타/유튜브/블로그), 동선 최적화, 식사 필수, 썸네일 필수
  2. 비용: 인당 비용, 실시간 대중교통, 가이드 시간당/인원, 식사비 최대값
  3. UI: 긴 한 페이지, 여행요약+지도 토글, 슬롯 색상, 출발지 설정, 하단 5탭
  4. 수익화: 드라이빙 가이드 앱 내 예약+결제

- **핵심 원칙**:
  - 식당 = 리뷰 수 절대 우선 (악플도 유명해서 생긴 것)
  - 한국어 구글맵 리뷰 있으면 반드시 반영
  - 빈 페이지 절대 불가 (이미지, 이유, 가격 모두 채움)
  - 구글맵 클릭 시 구글맵 앱 열기
  - 로딩 중 실시간 계산 과정 노출 (객관성 극대화)
